<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kpth Tone Perception Test</title>
    
    <!-- Load jsPsych -->
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/jspsych-instructions.js"></script>
    <script src="jspsych/jspsych-html-button-response.js"></script>
    <script src="jspsych/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych/jspsych-survey-multi-select.js"></script>
    <link href="css/jspsych.css" rel="stylesheet" type="text/css">
    
    <style>
        body { background-color: #f5f5f5; }
        .jspsych-btn { margin: 10px; padding: 15px 30px; font-size: 18px; }
        .jspsych-content-wrapper { width: 85%; max-width: 900px; }
        .jspsych-content { padding: 30px; }
        h1 { color: #333; margin-bottom: 20px; }
        .instruction-text { text-align: left; line-height: 1.6; font-size: 16px; }
        
        .audio-player { text-align: center; margin: 30px 0; }
        .play-button {
            background-color: #4CAF50; border: none; color: white; padding: 20px;
            text-align: center; display: inline-block; font-size: 16px; cursor: pointer;
            border-radius: 50%; width: 80px; height: 80px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s;
        }
        .play-button:hover { background-color: #45a049; box-shadow: 0 6px 12px rgba(0,0,0,0.3); transform: scale(1.05); }
        .play-button:active { transform: scale(0.95); }
        .play-icon { font-size: 32px; }
        
        /* Trial header with question number and progress */
        .trial-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            color: #666;
        }
        .trial-number {
            font-weight: bold;
            font-size: 20px;
            color: #333;
        }
        .progress-text {
            font-size: 16px;
            color: #888;
            margin-top: 5px;
        }
        
        /* Feedback styles */
        .feedback-correct {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }
        .feedback-incorrect {
            color: #f44336;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }
        .feedback-answer {
            font-size: 18px;
            margin: 10px 0;
        }
        
        .jspsych-survey-multi-choice-question,
        .jspsych-survey-multi-select-question { margin: 25px 0; text-align: left; }
        .jspsych-survey-multi-choice-text,
        .jspsych-survey-multi-select-text { font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        .jspsych-survey-multi-choice-option,
        .jspsych-survey-multi-select-option { margin: 8px 0; font-size: 15px; }
        
        .example-box {
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div id="jspsych-target"></div>
</body>

<script>

/******************************************************************************
 * Google Sheets Configuration
 ******************************************************************************/

const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxy2jeiMnswTsswoDh25FBCT1NcxsY5oFuRFyx-WnvwZrlArQNIIIvom5uyMAg_xW6h/exec';
// You need to create a Google Apps Script web app - instructions at the end

/******************************************************************************
 * Test Stimuli Configuration
 ******************************************************************************/

const testSections = {
    tone_practice: [
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'tone', answer: 'Low'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'tone', answer: 'High'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'tone', answer: 'Low'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'tone', answer: 'High'}
    ],
    tone_main: [
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'tone'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'tone'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'tone'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'tone'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'tone'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'tone'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'tone'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'tone'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'tone'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'tone'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'tone'}
    ],
    coda_practice: [
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'coda', answer: 'ak'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'coda', answer: 'ap'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'coda', answer: 'at'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'coda', answer: 'ah'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'coda', answer: 'ak'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'coda', answer: 'ap'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'coda', answer: 'at'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'coda', answer: 'ah'}
    ],
    coda_main: [
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V20-UTC007-P-NAN001.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'coda'},
        {audio: 'V23-UTC008-P-NAN001.wav', type: 'coda'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'coda'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'coda'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V15-UTC005-P-NAN001.wav', type: 'coda'},
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'coda'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'coda'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN002.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'coda'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'coda'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'coda'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'coda'}
    ],
    combined_main: [
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'combined'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'combined'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN001.wav', type: 'combined'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V20-UTC007-P-NAN001.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'combined'},
        {audio: 'V23-UTC008-P-NAN001.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'combined'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'combined'},
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'combined'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'combined'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V11-UTC004-P-NAN002.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'combined'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V17-UTC006-P-NAN002.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'combined'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'combined'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'combined'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'combined'},
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'combined'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'combined'},
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'combined'}
    ]
};

/******************************************************************************
 * Utility Functions
 ******************************************************************************/

function getTimestamp() {
    const dt = new Date();
    const year = dt.getFullYear();
    const month = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    const hour = String(dt.getHours()).padStart(2, '0');
    const minute = String(dt.getMinutes()).padStart(2, '0');
    const second = String(dt.getSeconds()).padStart(2, '0');
    return `${year}${month}${day}_${hour}${minute}${second}`;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

function createAudioPlayer(audioFile) {
    return `
        <div class="audio-player">
            <button class="play-button" onclick="playAudio('${audioFile}')">
                <span class="play-icon">▶</span>
            </button>
            <p>Click to play audio</p>
            <audio id="audio-${audioFile.replace(/[^a-zA-Z0-9]/g, '')}" preload="auto">
                <source src="sounds/${audioFile}" type="audio/wav">
            </audio>
        </div>
    `;
}

function playAudio(audioFile) {
    const audioId = 'audio-' + audioFile.replace(/[^a-zA-Z0-9]/g, '');
    const audio = document.getElementById(audioId);
    if (audio) {
        audio.currentTime = 0;
        audio.play();
    }
}

function createPerceptionTrial(stimulus, trialNum, totalTrials, sectionName, isPractice) {
    let choices, prompt;
    
    if (stimulus.type === 'tone') {
        choices = ['Low', 'High'];
        prompt = '<p><strong>Is this Low or High tone?</strong></p>';
    } else if (stimulus.type === 'coda') {
        choices = ['ak', 'ap', 'at', 'ah'];
        prompt = '<p><strong>Which coda do you hear?</strong></p>';
    } else {
        choices = ['Low-ak', 'Low-ap', 'Low-at', 'Low-ah', 'High-ak', 'High-ap', 'High-at', 'High-ah'];
        prompt = '<p><strong>Which tone and coda combination do you hear?</strong></p>';
    }
    
    const trial = {
        type: 'html-button-response',
        stimulus: function() {
            const percentage = Math.round((trialNum / totalTrials) * 100);
            const header = `
                <div class="trial-header">
                    <div class="trial-number">Question ${trialNum} of ${totalTrials}</div>
                    <div class="progress-text">Progress: ${percentage}%</div>
                </div>
            `;
            return header + createAudioPlayer(stimulus.audio) + prompt;
        },
        choices: choices,
        data: {
            question_number: trialNum,
            section: sectionName,
            stimulus: stimulus.audio,
            task_type: stimulus.type,
            is_practice: isPractice
        },
        on_finish: function(data) {
            data.response = choices[data.button_pressed];
            data.response_number = data.button_pressed + 1; // 1-based indexing
        }
    };
    
    // Add feedback for practice trials
    if (isPractice && stimulus.answer) {
        return [trial, {
            type: 'html-button-response',
            stimulus: function() {
                const lastTrial = jsPsych.data.get().last(1).values()[0];
                const correct = lastTrial.response === stimulus.answer;
                
                if (correct) {
                    return `
                        <div class="feedback-correct">✓ Correct!</div>
                        <div class="feedback-answer">You selected: ${lastTrial.response}</div>
                        <p>Click "Continue" for the next question.</p>
                    `;
                } else {
                    return `
                        <div class="feedback-incorrect">✗ Incorrect</div>
                        <div class="feedback-answer">You selected: ${lastTrial.response}</div>
                        <div class="feedback-answer">Correct answer: ${stimulus.answer}</div>
                        <p>Click "Continue" for the next question.</p>
                    `;
                }
            },
            choices: ['Continue']
        }];
    }
    
    return trial;
}

/******************************************************************************
 * Build Timeline
 ******************************************************************************/

var timeline = [];

// Welcome
timeline.push({
    type: 'instructions',
    pages: [`<h1>Welcome to the Perception Test</h1>
        <div class="instruction-text">
            <p>Thank you for participating!</p>
            <p>This test will take approximately <strong>20-25 minutes</strong> to complete.</p>
            <p>Please ensure you are in a quiet environment and wearing headphones.</p>
            <p>Click "Next" to continue.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Next'
});

// Demographics - Combined single page
timeline.push({
    type: 'survey-multi-choice',
    questions: [
        {
            prompt: '<strong>Q1. Age</strong>', 
            options: ['18-19', '20-22', '23-25', '26-30', '31-40', '41-49', '50-59', '60-69', '70-79', '80+'], 
            required: true, 
            name: 'Q1_Age'
        },
        {
            prompt: '<strong>Q2. Hearing Status</strong>', 
            options: ['No known hearing problems', 'Mild hearing problem / Tinnitus', 'Confirmed hearing diagnosis', 'Not sure'], 
            required: true, 
            name: 'Q2_Hearing'
        },
        {
            prompt: '<strong>Q3. First Language (L1)</strong>', 
            options: ['Japanese', 'English', 'Mandarin', 'Min Nan / Taiwanese', 'Cantonese', 'Korean', 'Thai', 'Other (Tonal)', 'Other (Non-tonal)'], 
            required: true, 
            name: 'Q3_L1'
        },
        {
            prompt: `<strong>Q4. Second Language(s) / Other Familiar Languages</strong><br>
                <small>(Select ALL languages you can understand or use. If none, select "None")</small>`, 
            options: ['None', 'Japanese', 'English', 'Mandarin', 'Min Nan / Taiwanese', 'Cantonese', 'Korean', 'Thai', 'French', 'German', 'Spanish', 'Italian', 'Russian', 'Other (Tonal)', 'Other (Non-tonal)'], 
            required: true, 
            name: 'Q4_L2'
        },
        {
            prompt: `<strong>Q5. Have you had long-term exposure to tonal language environments?</strong><br>
                <small>Tonal languages include: Mandarin Chinese, Cantonese, Thai, Vietnamese, etc.<br>
                In tonal languages, the pitch/tone changes the meaning of words.</small>
                <div class="example-box">
                    <strong>Examples:</strong><br>
                    • <strong>Mandarin:</strong> "mā" (mother) vs "mǎ" (horse) - same sound, different tone<br>
                    • <strong>Cantonese:</strong> Has 6-9 tones<br>
                    • <strong>Thai:</strong> Has 5 tones<br>
                    • <strong>English/Japanese/Korean:</strong> NOT tonal languages
                </div>
                <small>(Select ALL that apply. If none, select "Almost none")</small>`, 
            options: ['Almost none', 'Used at home or while growing up', 'Learned in school/classes', 'Lived in a tonal language region', 'Used regularly with friends/colleagues'], 
            required: true, 
            name: 'Q5_Tonal_Exposure'
        },
        {
            prompt: '<strong>Q6. Have you received music training?</strong>', 
            options: ['No', 'Yes (Non-systematic / Interest-based)', 'Yes (Systematic training)'], 
            required: true, 
            name: 'Q6_Music_Training'
        },
        {
            prompt: '<strong>Q7. Years of Music Training</strong>', 
            options: ['0', '1-2 years', '3-4 years', '5-7 years', '8-10 years', '10+ years'], 
            required: true, 
            name: 'Q7_Music_Years'
        },
        {
            prompt: '<strong>Q8. Do you have absolute pitch?</strong>', 
            options: ['Yes (Professionally tested and confirmed)', 'Possibly (Self-judgment)', 'No', 'Not sure'], 
            required: true, 
            name: 'Q8_Absolute_Pitch'
        },
        {
            prompt: '<strong>Q9. Testing Device</strong>', 
            options: ['Computer + Headphones', 'Computer + Speakers', 'Mobile + Headphones', 'Mobile + Speakers'], 
            required: true, 
            name: 'Q9_Device'
        },
        {
            prompt: '<strong>Q10. Current Environment Quietness</strong>', 
            options: ['Very quiet', 'Normal', 'Somewhat noisy'], 
            required: true, 
            name: 'Q10_Environment'
        },
        {
            prompt: '<strong>Q11. Have you studied linguistics/phonetics/pronunciation?</strong>', 
            options: ['No', 'Took one course/short training (< 1 semester)', 'Systematic study (≥ 1 semester)', 'Not sure'], 
            required: true, 
            name: 'Q11_Phonetics'
        },
        {
            prompt: '<strong>Q12. Can you read romanization/phonetic symbols to judge pronunciation?</strong>', 
            options: ['Not at all', 'A little (very general)', 'Quite well (commonly used)', 'Not sure'], 
            required: true, 
            name: 'Q12_Romanization'
        },
        {
            prompt: `<strong>Q13. Does your native/main language have common word-final consonants (codas)?</strong><br>
                <small>Codas are consonants at the end of syllables, like -p, -t, -k, -m, -n, -ng</small>
                <div class="example-box">
                    <strong>Examples:</strong><br>
                    • <strong>English:</strong> "cat" (-t), "cup" (-p), "back" (-k) → Codas are COMMON<br>
                    • <strong>Korean:</strong> "밥" (bap), "받" (bat), "박" (bak) → Codas are COMMON<br>
                    • <strong>Cantonese:</strong> "白" (baak), "八" (baat), "北" (bak) → Codas are COMMON<br>
                    • <strong>Japanese:</strong> Most syllables end in vowels (ka, ki, ku...) → Codas are RARE<br>
                    • <strong>Mandarin:</strong> Limited codas (-n, -ng only) → Somewhat rare
                </div>`, 
            options: ['Yes (Codas like -p/-t/-k are common)', 'Somewhat (Some codas exist)', 'Very few/almost none', 'Not sure'], 
            required: true, 
            name: 'Q13_Coda'
        }
    ],
    preamble: '<h1>Participant Information</h1><p>Please answer all questions to help us understand your language background.</p>',
    button_label: 'Continue to Test'
});

// Calculate trial counters
let trialNum = 1;
let totalTrials = 4 + 20 + 8 + 40 + 40; // practice + main trials only (no repeat labels)

// Section 1: Tone Practice
timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 1: Tone Practice (4 trials)</h1>
        <div class="instruction-text">
            <p>You will practice identifying <strong>Low</strong> vs <strong>High</strong> tones.</p>
            <p>After each answer, you will see if you were correct.</p>
            <p>Click the green button to play audio. You can replay as many times as you want.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.tone_practice.forEach(stim => {
    const trials = createPerceptionTrial(stim, trialNum++, totalTrials, 'Tone_Practice', true);
    if (Array.isArray(trials)) {
        trials.forEach(t => timeline.push(t));
    } else {
        timeline.push(trials);
    }
});

// Section 2: Tone Main (including repeats, but not labeled)
timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 2: Tone Test (20 trials)</h1>
        <div class="instruction-text">
            <p>Now the actual test begins.</p>
            <p>Continue identifying Low vs High tones.</p>
            <p>You will NOT see correct answers anymore.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.tone_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Tone_Main', false));
});

// Section 3: Coda Practice
timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 3: Coda Practice (8 trials)</h1>
        <div class="instruction-text">
            <p>Now you will practice identifying word-final consonants (codas).</p>
            <p>Listen for: <strong>ak, ap, at, or ah</strong></p>
            <p>After each answer, you will see if you were correct.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.coda_practice.forEach(stim => {
    const trials = createPerceptionTrial(stim, trialNum++, totalTrials, 'Coda_Practice', true);
    if (Array.isArray(trials)) {
        trials.forEach(t => timeline.push(t));
    } else {
        timeline.push(trials);
    }
});

// Section 4: Coda Main (including repeats, but not labeled)
timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 4: Coda Test (40 trials)</h1>
        <div class="instruction-text">
            <p>Continue identifying codas: ak, ap, at, or ah</p>
            <p>You will NOT see correct answers anymore.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.coda_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Coda_Main', false));
});

// Section 5: Combined Main (including repeats, but not labeled)
timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 5: Combined Test (40 trials)</h1>
        <div class="instruction-text">
            <p>Now you will identify BOTH tone and coda together.</p>
            <p>Options: Low-ak, Low-ap, Low-at, Low-ah, High-ak, High-ap, High-at, High-ah</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.combined_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Combined_Main', false));
});

// Debrief
timeline.push({
    type: 'instructions',
    pages: [`<h1>Test Complete!</h1>
        <div class="instruction-text">
            <p>Thank you for your participation!</p>
            <p>Your data is being uploaded...</p>
            <p>Click "Finish" to save and complete.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Finish'
});

/******************************************************************************
 * Run Experiment
 ******************************************************************************/

const questionOptions = {
    'Q1_Age': ['18-19', '20-22', '23-25', '26-30', '31-40', '41-49', '50-59', '60-69', '70-79', '80+'],
    'Q2_Hearing': ['No known hearing problems', 'Mild hearing problem / Tinnitus', 'Confirmed hearing diagnosis', 'Not sure'],
    'Q3_L1': ['Japanese', 'English', 'Mandarin', 'Min Nan / Taiwanese', 'Cantonese', 'Korean', 'Thai', 'Other (Tonal)', 'Other (Non-tonal)'],
    'Q4_L2': ['None', 'Japanese', 'English', 'Mandarin', 'Min Nan / Taiwanese', 'Cantonese', 'Korean', 'Thai', 'French', 'German', 'Spanish', 'Italian', 'Russian', 'Other (Tonal)', 'Other (Non-tonal)'],
    'Q5_Tonal_Exposure': ['Almost none', 'Used at home or while growing up', 'Learned in school/classes', 'Lived in a tonal language region', 'Used regularly with friends/colleagues'],
    'Q6_Music_Training': ['No', 'Yes (Non-systematic / Interest-based)', 'Yes (Systematic training)'],
    'Q7_Music_Years': ['0', '1-2 years', '3-4 years', '5-7 years', '8-10 years', '10+ years'],
    'Q8_Absolute_Pitch': ['Yes (Professionally tested and confirmed)', 'Possibly (Self-judgment)', 'No', 'Not sure'],
    'Q9_Device': ['Computer + Headphones', 'Computer + Speakers', 'Mobile + Headphones', 'Mobile + Speakers'],
    'Q10_Environment': ['Very quiet', 'Normal', 'Somewhat noisy'],
    'Q11_Phonetics': ['No', 'Took one course/short training (< 1 semester)', 'Systematic study (≥ 1 semester)', 'Not sure'],
    'Q12_Romanization': ['Not at all', 'A little (very general)', 'Quite well (commonly used)', 'Not sure'],
    'Q13_Coda': ['Yes (Codas like -p/-t/-k are common)', 'Somewhat (Some codas exist)', 'Very few/almost none', 'Not sure']
};

jsPsych.init({
    timeline: timeline,
    show_progress_bar: true,
    on_finish: function() {
        var allData = jsPsych.data.get();
        
        // Get demographics
        var demoData = allData.filter({trial_type: 'survey-multi-choice'});
        var demoResponses = {};
        if (demoData.count() > 0) {
            demoResponses = demoData.values()[0].responses;
        }
        
        // Get perception trials
        var perceptionData = allData.filter({trial_type: 'html-button-response'}).filter(function(trial) {
            return trial.question_number !== undefined && !trial.choices.includes('Continue');
        });
        
        // Build CSV with 1-based indexing
        var csvContent = "Question_Number,Response,Response_Number\n";
        
        // Add demographics (Q1-Q13) with 1-based response numbers
        ['Q1_Age', 'Q2_Hearing', 'Q3_L1', 'Q4_L2', 'Q5_Tonal_Exposure', 'Q6_Music_Training', 'Q7_Music_Years', 'Q8_Absolute_Pitch', 'Q9_Device', 'Q10_Environment', 'Q11_Phonetics', 'Q12_Romanization', 'Q13_Coda'].forEach(function(qKey) {
            if (demoResponses[qKey]) {
                var response = demoResponses[qKey];
                var responseNum = questionOptions[qKey].indexOf(response) + 1; // 1-based
                csvContent += `${qKey},"${response}",${responseNum}\n`;
            }
        });
        
        // Add perception trials (already 1-based from data.response_number)
        perceptionData.values().forEach(function(trial) {
            var qNum = parseInt(trial.question_number) + 13; // Offset by 13 background questions
            csvContent += `${qNum},${trial.response},${trial.response_number}\n`;
        });
        
        // Download CSV
        var filename = 'kpth_perception_' + getTimestamp() + '.csv';
        downloadCSV(csvContent, filename);
        
        // Upload to Google Sheets (if configured)
        uploadToGoogleSheets(csvContent);
        
        document.querySelector('#jspsych-content').innerHTML = 
            '<h1>Data saved! Thank you for participating.</h1><p>You may close this page.</p>';
    }
});

function uploadToGoogleSheets(csvData) {
    // This will work once you set up the Google Apps Script
    fetch(GOOGLE_SHEETS_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'text/plain',
        },
        body: csvData
    }).then(function() {
        console.log('Data uploaded to Google Sheets');
    }).catch(function(error) {
        console.log('Could not upload to Google Sheets:', error);
    });
}

</script>
</html>

<!--
===============================================================================
GOOGLE SHEETS SETUP INSTRUCTIONS:
===============================================================================

1. Open your Google Sheet: https://docs.google.com/spreadsheets/d/19mQs7IKcp7d1-x8D1Kk9ehwunllwdHiKsy7yl_0FToE/edit

2. Click "Extensions" → "Apps Script"

3. Delete any existing code and paste this:

function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = e.postData.contents;
  
  // Parse CSV
  var rows = data.split('\n');
  var timestamp = new Date();
  
  // Add each row with timestamp
  rows.forEach(function(row) {
    if (row.trim()) {
      var cols = row.split(',');
      sheet.appendRow([timestamp].concat(cols));
    }
  });
  
  return ContentService.createTextOutput('Success');
}

4. Click "Deploy" → "New deployment"

5. Click the gear icon ⚙️ → Select "Web app"

6. Settings:
   - Execute as: "Me"
   - Who has access: "Anyone"
   
7. Click "Deploy"

8. Copy the "Web app URL" (looks like: https://script.google.com/macros/s/XXXXX/exec)

9. Replace GOOGLE_SHEETS_URL in this HTML file with your Web app URL

10. Done! Data will now automatically upload to your Google Sheet
===============================================================================
-->
