<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kpth Tone Perception Test</title>
    
    <!-- Load jsPsych -->
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/jspsych-instructions.js"></script>
    <script src="jspsych/jspsych-html-button-response.js"></script>
    <script src="jspsych/jspsych-form.js"></script>
    <link href="css/jspsych.css" rel="stylesheet" type="text/css">
    
    <style>
        body { background-color: #f5f5f5; }
        .jspsych-btn { margin: 10px; padding: 15px 30px; font-size: 18px; }
        .jspsych-content-wrapper { width: 85%; max-width: 900px; }
        .jspsych-content { padding: 30px; }
        h1 { color: #333; margin-bottom: 20px; }
        .instruction-text { text-align: left; line-height: 1.6; font-size: 16px; }
        
        .audio-player { text-align: center; margin: 30px 0; }
        .play-button {
            background-color: #4CAF50; border: none; color: white; padding: 20px;
            text-align: center; display: inline-block; font-size: 16px; cursor: pointer;
            border-radius: 50%; width: 80px; height: 80px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s;
        }
        .play-button:hover { background-color: #45a049; box-shadow: 0 6px 12px rgba(0,0,0,0.3); transform: scale(1.05); }
        .play-button:active { transform: scale(0.95); }
        .play-icon { font-size: 32px; }
        
        .trial-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            color: #666;
        }
        .trial-number {
            font-weight: bold;
            font-size: 20px;
            color: #333;
        }
        .progress-text {
            font-size: 16px;
            color: #888;
            margin-top: 5px;
        }
        
        .feedback-correct {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }
        .feedback-incorrect {
            color: #f44336;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }
        .feedback-answer {
            font-size: 18px;
            margin: 10px 0;
        }
        
        .requirement-box {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            font-size: 15px;
        }
        .requirement-box strong {
            color: #856404;
        }
        
        /* Form styling */
        .survey-form {
            text-align: left;
            max-width: 800px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 25px;
        }
        .form-group label {
            display: block;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        .form-group small {
            display: block;
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .form-group select,
        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            max-width: 500px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
        }
        .form-group select {
            cursor: pointer;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
    </style>
</head>

<body>
    <div id="jspsych-target"></div>
</body>

<script>

/******************************************************************************
 * Google Sheets Configuration
 ******************************************************************************/

const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';

/******************************************************************************
 * Test Stimuli Configuration
 ******************************************************************************/

const testSections = {
    tone_practice: [
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'tone', answer: 'Low'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'tone', answer: 'High'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'tone', answer: 'Low'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'tone', answer: 'High'}
    ],
    tone_main: [
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'tone'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'tone'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'tone'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'tone'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'tone'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'tone'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'tone'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'tone'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'tone'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'tone'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'tone'}
    ],
    coda_practice: [
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'coda', answer: 'ak'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'coda', answer: 'ap'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'coda', answer: 'at'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'coda', answer: 'ah'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'coda', answer: 'ak'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'coda', answer: 'ap'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'coda', answer: 'at'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'coda', answer: 'ah'}
    ],
    coda_main: [
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V20-UTC007-P-NAN001.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'coda'},
        {audio: 'V23-UTC008-P-NAN001.wav', type: 'coda'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'coda'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'coda'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V15-UTC005-P-NAN001.wav', type: 'coda'},
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'coda'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'coda'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN002.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'coda'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'coda'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'coda'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'coda'}
    ],
    combined_main: [
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'combined'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'combined'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN001.wav', type: 'combined'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V20-UTC007-P-NAN001.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'combined'},
        {audio: 'V23-UTC008-P-NAN001.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'combined'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'combined'},
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'combined'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'combined'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V11-UTC004-P-NAN002.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'combined'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V17-UTC006-P-NAN002.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'combined'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'combined'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'combined'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'combined'},
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'combined'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'combined'},
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'combined'}
    ]
};

// Data for dropdowns
const countries = ["Afghanistan", "Albania", "Algeria", "Argentina", "Australia", "Austria", "Bangladesh", "Belgium", "Brazil", "Canada", "Chile", "China", "Colombia", "Denmark", "Egypt", "Finland", "France", "Germany", "Greece", "Hong Kong", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Japan", "Kenya", "Malaysia", "Mexico", "Netherlands", "New Zealand", "Nigeria", "Norway", "Pakistan", "Philippines", "Poland", "Portugal", "Russia", "Saudi Arabia", "Singapore", "South Africa", "South Korea", "Spain", "Sweden", "Switzerland", "Taiwan", "Thailand", "Turkey", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Vietnam", "Other"];

const regionsByCountry = {
    "United States": ["Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming", "Other"],
    "China": ["Beijing", "Shanghai", "Guangdong", "Zhejiang", "Jiangsu", "Sichuan", "Hubei", "Fujian", "Hunan", "Anhui", "Hebei", "Liaoning", "Shaanxi", "Jiangxi", "Chongqing", "Shandong", "Yunnan", "Henan", "Guangxi", "Gansu", "Shanxi", "Guizhou", "Jilin", "Inner Mongolia", "Tianjin", "Heilongjiang", "Ningxia", "Hainan", "Qinghai", "Tibet", "Xinjiang", "Hong Kong", "Macau", "Other"],
    "Japan": ["Tokyo", "Osaka", "Kyoto", "Hokkaido", "Kanagawa", "Aichi", "Fukuoka", "Saitama", "Chiba", "Hyogo", "Hiroshima", "Shizuoka", "Miyagi", "Nagano", "Gifu", "Niigata", "Ibaraki", "Tochigi", "Gunma", "Okayama", "Kumamoto", "Kagoshima", "Okinawa", "Other"],
    "South Korea": ["Seoul", "Busan", "Incheon", "Daegu", "Daejeon", "Gwangju", "Ulsan", "Gyeonggi-do", "Gangwon-do", "Jeju", "Other"],
    "Taiwan": ["Taipei", "New Taipei", "Taoyuan", "Taichung", "Tainan", "Kaohsiung", "Other"],
    "United Kingdom": ["England", "Scotland", "Wales", "Northern Ireland", "Other"],
    "Canada": ["Ontario", "Quebec", "British Columbia", "Alberta", "Manitoba", "Saskatchewan", "Other"],
    "Australia": ["New South Wales", "Victoria", "Queensland", "Western Australia", "South Australia", "Tasmania", "Other"],
    "Germany": ["Bavaria", "Berlin", "Hamburg", "North Rhine-Westphalia", "Baden-Württemberg", "Other"],
    "France": ["Île-de-France", "Provence-Alpes-Côte d'Azur", "Auvergne-Rhône-Alpes", "Other"]
};

const languages = ["Arabic", "Bengali", "Cantonese", "Czech", "Danish", "Dutch", "English", "Finnish", "French", "German", "Greek", "Hebrew", "Hindi", "Hungarian", "Indonesian", "Italian", "Japanese", "Korean", "Malay", "Mandarin", "Min Nan / Taiwanese", "Norwegian", "Persian", "Polish", "Portuguese", "Punjabi", "Romanian", "Russian", "Spanish", "Swahili", "Swedish", "Tagalog", "Tamil", "Telugu", "Thai", "Turkish", "Ukrainian", "Urdu", "Vietnamese", "Other"];

/******************************************************************************
 * Utility Functions
 ******************************************************************************/

function getTimestamp() {
    const dt = new Date();
    const year = dt.getFullYear();
    const month = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    const hour = String(dt.getHours()).padStart(2, '0');
    const minute = String(dt.getMinutes()).padStart(2, '0');
    const second = String(dt.getSeconds()).padStart(2, '0');
    return `${year}${month}${day}_${hour}${minute}${second}`;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

function createAudioPlayer(audioFile) {
    return `
        <div class="audio-player">
            <button class="play-button" onclick="playAudio('${audioFile}')">
                <span class="play-icon">▶</span>
            </button>
            <p>Click to play audio</p>
            <audio id="audio-${audioFile.replace(/[^a-zA-Z0-9]/g, '')}" preload="auto">
                <source src="sounds/${audioFile}" type="audio/wav">
            </audio>
        </div>
    `;
}

function playAudio(audioFile) {
    const audioId = 'audio-' + audioFile.replace(/[^a-zA-Z0-9]/g, '');
    const audio = document.getElementById(audioId);
    if (audio) {
        audio.currentTime = 0;
        audio.play();
    }
}

function createPerceptionTrial(stimulus, trialNum, totalTrials, sectionName, isPractice) {
    let choices, prompt;
    
    if (stimulus.type === 'tone') {
        choices = ['Low', 'High'];
        prompt = '<p><strong>Is this Low or High tone?</strong></p>';
    } else if (stimulus.type === 'coda') {
        choices = ['ak', 'ap', 'at', 'ah'];
        prompt = '<p><strong>Which coda do you hear?</strong></p>';
    } else {
        choices = ['Low-ak', 'Low-ap', 'Low-at', 'Low-ah', 'High-ak', 'High-ap', 'High-at', 'High-ah'];
        prompt = '<p><strong>Which tone and coda combination do you hear?</strong></p>';
    }
    
    const trial = {
        type: 'html-button-response',
        stimulus: function() {
            const percentage = Math.round((trialNum / totalTrials) * 100);
            const header = `
                <div class="trial-header">
                    <div class="trial-number">Question ${trialNum} of ${totalTrials}</div>
                    <div class="progress-text">Progress: ${percentage}%</div>
                </div>
            `;
            return header + createAudioPlayer(stimulus.audio) + prompt;
        },
        choices: choices,
        data: {
            question_number: trialNum,
            section: sectionName,
            stimulus: stimulus.audio,
            task_type: stimulus.type,
            is_practice: isPractice
        },
        on_finish: function(data) {
            data.response = choices[data.button_pressed];
            data.response_number = data.button_pressed + 1;
        }
    };
    
    if (isPractice && stimulus.answer) {
        return [trial, {
            type: 'html-button-response',
            stimulus: function() {
                const lastTrial = jsPsych.data.get().last(1).values()[0];
                const correct = lastTrial.response === stimulus.answer;
                
                if (correct) {
                    return `
                        <div class="feedback-correct">✓ Correct!</div>
                        <div class="feedback-answer">You selected: ${lastTrial.response}</div>
                        <p>Click "Continue" for the next question.</p>
                    `;
                } else {
                    return `
                        <div class="feedback-incorrect">✗ Incorrect</div>
                        <div class="feedback-answer">You selected: ${lastTrial.response}</div>
                        <div class="feedback-answer">Correct answer: ${stimulus.answer}</div>
                        <p>Click "Continue" for the next question.</p>
                    `;
                }
            },
            choices: ['Continue']
        }];
    }
    
    return trial;
}

// Generate age options HTML
function generateAgeOptions() {
    let html = '<option value="">-- Select Age --</option>';
    for (let i = 0; i <= 100; i++) {
        html += `<option value="${i}">${i}</option>`;
    }
    return html;
}

// Generate music years options HTML
function generateMusicYearsOptions() {
    let html = '<option value="">-- Select Years --</option>';
    for (let i = 0; i <= 50; i++) {
        html += `<option value="${i}">${i}</option>`;
    }
    return html;
}

// Generate country options HTML
function generateCountryOptions() {
    let html = '<option value="">-- Select Country --</option>';
    countries.forEach(country => {
        html += `<option value="${country}">${country}</option>`;
    });
    return html;
}

// Generate language options HTML
function generateLanguageOptions() {
    let html = '<option value="">-- Select Language --</option>';
    languages.forEach(lang => {
        html += `<option value="${lang}">${lang}</option>`;
    });
    return html;
}

/******************************************************************************
 * Build Timeline
 ******************************************************************************/

var timeline = [];

// Welcome
timeline.push({
    type: 'instructions',
    pages: [`<h1>Welcome to the Perception Test</h1>
        <div class="instruction-text">
            <p>Thank you for participating in this study!</p>
            <p>This test will take approximately <strong>6-8 minutes</strong> to complete.</p>
            
            <div class="requirement-box">
                <strong>Requirements - Please ensure:</strong><br>
                ✓ You have <strong>no known hearing problems</strong><br>
                ✓ You are wearing <strong>headphones or earphones</strong><br>
                ✓ You are using a <strong>computer or tablet</strong> (larger screen preferred)<br>
                ✓ You are in a <strong>quiet environment</strong>
            </div>
            
            <p>If you meet all these requirements, click "Next" to continue to the background survey.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Next'
});

// Background Survey - All questions on one page using HTML form
timeline.push({
    type: 'form',
    button_label: 'Start Test',
    questions: [
        {
            type: 'html',
            prompt: `
            <div class="survey-form">
                <h1>Background Survey</h1>
                <p style="margin-bottom: 30px;">Please answer all questions.</p>
                
                <div class="form-group">
                    <label for="q1_age">Q1. What is your age?</label>
                    <small>Please select a number between 0 and 100</small>
                    <select id="q1_age" name="Q1_Age" required>
                        ${generateAgeOptions()}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="q2_gender">Q2. What is your gender?</label>
                    <select id="q2_gender" name="Q2_Gender" required>
                        <option value="">-- Select Gender --</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="q3_country">Q3. Where do you come from?</label>
                    <small>Select country and region</small>
                    <select id="q3_country" name="Q3_Country" required onchange="updateRegionOptions()">
                        ${generateCountryOptions()}
                    </select>
                    <select id="q3_region" name="Q3_Region" required style="margin-top: 10px;">
                        <option value="">-- First select a country --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="q4_l1">Q4. Which language did you mainly use before the age of 12?</label>
                    <small>Please select ONE option</small>
                    <select id="q4_l1" name="Q4_L1" required>
                        ${generateLanguageOptions()}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="q5_languages">Q5. Which other languages can you speak fluently?</label>
                    <small>List all languages separated by commas, or write "None" if no other languages.<br>Example: English, Mandarin, Korean</small>
                    <textarea id="q5_languages" name="Q5_Languages" required placeholder="e.g., English, Mandarin or None"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="q6_music">Q6. How many years of formal musical training have you received?</label>
                    <small>Please select a number between 0 and 50</small>
                    <select id="q6_music" name="Q6_Music_Years" required>
                        ${generateMusicYearsOptions()}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="q7_pitch">Q7. Do you have absolute pitch?</label>
                    <select id="q7_pitch" name="Q7_Absolute_Pitch" required>
                        <option value="">-- Select --</option>
                        <option value="YES">YES</option>
                        <option value="NO">NO</option>
                        <option value="Not Sure">Not Sure</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="q8_training">Q8. Have you received any formal pronunciation training?</label>
                    <select id="q8_training" name="Q8_Pronunciation_Training" required>
                        <option value="">-- Select --</option>
                        <option value="YES">YES</option>
                        <option value="NO">NO</option>
                    </select>
                </div>
            </div>
            
            <script>
                function updateRegionOptions() {
                    const country = document.getElementById('q3_country').value;
                    const regionSelect = document.getElementById('q3_region');
                    regionSelect.innerHTML = '<option value="">-- Select Region --</option>';
                    
                    const regions = ${JSON.stringify(regionsByCountry)}[country];
                    if (regions) {
                        regions.forEach(function(region) {
                            const option = document.createElement('option');
                            option.value = region;
                            option.textContent = region;
                            regionSelect.appendChild(option);
                        });
                    } else {
                        regionSelect.innerHTML = '<option value="Other">Other</option>';
                    }
                }
            </script>
            `
        }
    ]
});

// Calculate trial counters
let trialNum = 1;
let totalTrials = 4 + 20 + 8 + 40 + 40;

// Tone Practice
timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 1: Tone Practice (4 trials)</h1>
        <div class="instruction-text">
            <p>You will practice identifying <strong>Low</strong> vs <strong>High</strong> tones.</p>
            <p>After each answer, you will see if you were correct.</p>
            <p>Click the green button to play audio. You can replay as many times as you want.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.tone_practice.forEach(stim => {
    const trials = createPerceptionTrial(stim, trialNum++, totalTrials, 'Tone_Practice', true);
    if (Array.isArray(trials)) {
        trials.forEach(t => timeline.push(t));
    } else {
        timeline.push(trials);
    }
});

// Tone Main
timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 2: Tone Test (20 trials)</h1>
        <div class="instruction-text">
            <p>Now the actual test begins.</p>
            <p>Continue identifying Low vs High tones.</p>
            <p>You will NOT see correct answers anymore.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.tone_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Tone_Main', false));
});

// Coda Practice
timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 3: Coda Practice (8 trials)</h1>
        <div class="instruction-text">
            <p>Now you will practice identifying word-final consonants (codas).</p>
            <p>Listen for: <strong>ak, ap, at, or ah</strong></p>
            <p>After each answer, you will see if you were correct.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.coda_practice.forEach(stim => {
    const trials = createPerceptionTrial(stim, trialNum++, totalTrials, 'Coda_Practice', true);
    if (Array.isArray(trials)) {
        trials.forEach(t => timeline.push(t));
    } else {
        timeline.push(trials);
    }
});

// Coda Main
timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 4: Coda Test (40 trials)</h1>
        <div class="instruction-text">
            <p>Continue identifying codas: ak, ap, at, or ah</p>
            <p>You will NOT see correct answers anymore.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.coda_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Coda_Main', false));
});

// Combined Main
timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 5: Combined Test (40 trials)</h1>
        <div class="instruction-text">
            <p>Now you will identify BOTH tone and coda together.</p>
            <p>Options: Low-ak, Low-ap, Low-at, Low-ah, High-ak, High-ap, High-at, High-ah</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.combined_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Combined_Main', false));
});

// Debrief
timeline.push({
    type: 'instructions',
    pages: [`<h1>Test Complete!</h1>
        <div class="instruction-text">
            <p>Thank you for your participation!</p>
            <p>Your data is being saved...</p>
            <p>Click "Finish" to complete.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Finish'
});

/******************************************************************************
 * Run Experiment
 ******************************************************************************/

jsPsych.init({
    timeline: timeline,
    show_progress_bar: true,
    on_finish: function() {
        var allData = jsPsych.data.get();
        
        // Get survey responses
        var surveyData = allData.filter({trial_type: 'form'}).values()[0];
        var responses = surveyData ? surveyData.responses : {};
        
        // Get perception trials
        var perceptionData = allData.filter({trial_type: 'html-button-response'}).filter(function(trial) {
            return trial.question_number !== undefined && !trial.choices.includes('Continue');
        });
        
        // Build CSV with 1-based indexing
        var csvContent = "Question_Number,Response,Response_Number\n";
        
        // Add survey responses
        var age = responses.Q1_Age || 'N/A';
        csvContent += `Q1_Age,"${age}",${age}\n`;
        
        var genderOptions = ['Male', 'Female', 'Prefer not to say'];
        var genderNum = genderOptions.indexOf(responses.Q2_Gender) + 1;
        csvContent += `Q2_Gender,"${responses.Q2_Gender || 'N/A'}",${genderNum || 'N/A'}\n`;
        
        csvContent += `Q3_Country,"${responses.Q3_Country || 'N/A'}",N/A\n`;
        csvContent += `Q3_Region,"${responses.Q3_Region || 'N/A'}",N/A\n`;
        
        var langIndex = languages.indexOf(responses.Q4_L1) + 1;
        csvContent += `Q4_L1,"${responses.Q4_L1 || 'N/A'}",${langIndex || 'N/A'}\n`;
        
        csvContent += `Q5_Languages,"${responses.Q5_Languages || 'N/A'}",N/A\n`;
        
        var musicYears = responses.Q6_Music_Years || 'N/A';
        csvContent += `Q6_Music_Years,"${musicYears}",${musicYears}\n`;
        
        var pitchOptions = ['YES', 'NO', 'Not Sure'];
        var pitchNum = pitchOptions.indexOf(responses.Q7_Absolute_Pitch) + 1;
        csvContent += `Q7_Absolute_Pitch,"${responses.Q7_Absolute_Pitch || 'N/A'}",${pitchNum || 'N/A'}\n`;
        
        var trainOptions = ['YES', 'NO'];
        var trainNum = trainOptions.indexOf(responses.Q8_Pronunciation_Training) + 1;
        csvContent += `Q8_Pronunciation_Training,"${responses.Q8_Pronunciation_Training || 'N/A'}",${trainNum || 'N/A'}\n`;
        
        // Add perception trials
        perceptionData.values().forEach(function(trial) {
            var qNum = parseInt(trial.question_number) + 8;
            csvContent += `${qNum},${trial.response},${trial.response_number}\n`;
        });
        
        // Download CSV
        var filename = 'kpth_perception_' + getTimestamp() + '.csv';
        downloadCSV(csvContent, filename);
        
        // Upload to Google Sheets
        uploadToGoogleSheets(csvContent);
        
        document.querySelector('#jspsych-content').innerHTML = 
            '<h1>Data saved! Thank you for participating.</h1><p>You may close this page.</p>';
    }
});

function uploadToGoogleSheets(csvData) {
    fetch(GOOGLE_SHEETS_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'text/plain',
        },
        body: csvData
    }).then(function() {
        console.log('Data uploaded to Google Sheets');
    }).catch(function(error) {
        console.log('Could not upload to Google Sheets:', error);
    });
}

</script>
</html>
