<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kpth Tone Perception Test / 音調知覺測試 / 音調知覚テスト</title>
    
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/jspsych-instructions.js"></script>
    <script src="jspsych/jspsych-html-button-response.js"></script>
    <link href="css/jspsych.css" rel="stylesheet" type="text/css">
    
    <style>
        body { background-color: #f5f5f5; }
        .jspsych-btn { margin: 10px; padding: 15px 30px; font-size: 18px; }
        .jspsych-content-wrapper { width: 85%; max-width: 900px; }
        .jspsych-content { padding: 30px; }
        h1 { color: #333; margin-bottom: 20px; }
        .instruction-text { text-align: left; line-height: 1.6; font-size: 16px; }
        
        .audio-player { text-align: center; margin: 30px 0; }
        .play-button {
            background-color: #4CAF50; border: none; color: white; padding: 20px;
            text-align: center; display: inline-block; font-size: 16px; cursor: pointer;
            border-radius: 50%; width: 80px; height: 80px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s;
        }
        .play-button:hover { background-color: #45a049; box-shadow: 0 6px 12px rgba(0,0,0,0.3); transform: scale(1.05); }
        .play-button:active { transform: scale(0.95); }
        .play-button:disabled { background-color: #cccccc; cursor: not-allowed; box-shadow: none; }
        .play-icon { font-size: 32px; }
        
        .trial-header { text-align: center; margin-bottom: 20px; font-size: 18px; color: #666; }
        .trial-number { font-weight: bold; font-size: 20px; color: #333; }
        .progress-text { font-size: 16px; color: #888; margin-top: 5px; }
        
        .feedback-correct { color: #4CAF50; font-size: 24px; font-weight: bold; margin: 20px 0; }
        .feedback-incorrect { color: #f44336; font-size: 24px; font-weight: bold; margin: 20px 0; }
        .feedback-answer { font-size: 18px; margin: 10px 0; }
        
        .requirement-box {
            background-color: #fff3cd; border-left: 4px solid #ffc107;
            padding: 15px; margin: 20px 0; font-size: 15px;
        }
        .requirement-box strong { color: #856404; }
        
        .consent-box {
            background-color: #d1ecf1; border-left: 4px solid #0c5460;
            padding: 15px; margin: 20px 0; font-size: 15px;
        }
        .consent-box strong { color: #0c5460; }
        
        .survey-form { text-align: left; max-width: 700px; margin: 0 auto; }
        .form-group { margin-bottom: 25px; }
        .form-group label {
            display: block; font-size: 16px; font-weight: bold;
            margin-bottom: 8px; color: #333;
        }
        .form-group small {
            display: block; color: #666; font-size: 14px; margin-bottom: 8px;
        }
        .form-group .explanation {
            display: block; color: #0066cc; font-size: 13px; 
            margin-top: 5px; font-style: italic;
        }
        .form-group select {
            width: 100%; max-width: 500px; padding: 10px;
            font-size: 16px; border: 1px solid #ccc;
            border-radius: 4px; background-color: white;
            cursor: pointer;
        }
        .language-select-container { margin-top: 15px; }
        .language-select-item { margin-bottom: 10px; }
        
        .lang-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #ddd; }
        .lang-section:last-child { border-bottom: none; }
        
        .error-message { color: #ff0000; font-size: 14px; margin-top: 10px; }
        
        .email-reminder {
            background-color: #d4edda; border-left: 4px solid #28a745;
            padding: 15px; margin: 20px 0; font-size: 16px;
            border-radius: 4px;
        }
        .email-reminder strong { color: #155724; }
    </style>
</head>

<body></body>

<script>

window.surveyData = {
    Q1_Age: '', Q2_Gender: '', Q3_Country: '', Q3_Region: '',
    Q4_Num_L1: '', Q4_L1_Languages: '',
    Q5_Num_Languages: '', Q5_Languages: '',
    Q6_Music_Years: '', Q7_Absolute_Pitch: '', Q8_Pronunciation_Training: ''
};

const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';

// pilot1.5 audio files
const testSections = {
    tone_practice: [
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'tone', answer: 'Low'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'tone', answer: 'High'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'tone', answer: 'Low'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'tone', answer: 'High'}
    ],
    
    tone_main: [
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'tone'},
	    {audio: 'V05-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'tone'},
        {audio: 'V11-UTC004-P-NAN002.wav', type: 'tone'},
	    {audio: 'V17-UTC006-P-NAN003.wav', type: 'tone'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'tone'},
        {audio: 'V20-UTC007-P-NAN003.wav', type: 'tone'},
        {audio: 'V11-UTC004-P-NAN003.wav', type: 'tone'},
        {audio: 'V17-UTC006-P-NAN002.wav', type: 'tone'},
        {audio: 'V02-UTC001-P-NAN003.wav', type: 'tone'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'tone'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'tone'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'tone'},
	    {audio: 'V05-UTC002-P-NAN004.wav', type: 'tone'},
        {audio: 'V23-UTC008-P-NAN003.wav', type: 'tone'}
    ],
    
    coda_practice: [
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'coda', answer: 'ak'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'coda', answer: 'ak'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'coda', answer: 'ap'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'coda', answer: 'ap'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'coda', answer: 'at'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'coda', answer: 'at'},
        {audio: 'V20-UTC007-P-NAN001.wav', type: 'coda', answer: 'ah'},
        {audio: 'V23-UTC008-P-NAN001.wav', type: 'coda', answer: 'ah'}
    ],
    
    coda_main_p: [
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN004.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V15-UTC005-P-NAN004.wav', type: 'coda'},
        {audio: 'V20-UTC007-P-NAN004.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN003.wav', type: 'coda'},
        {audio: 'V08-UTC003-P-NAN004.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'coda'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN003.wav', type: 'coda'},
        {audio: 'V05-UTC002-P-NAN004.wav', type: 'coda'},
        {audio: 'V23-UTC008-P-NAN004.wav', type: 'coda'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN002.wav', type: 'coda'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'coda'}
    ],
    
    coda_main_a: [
        {audio: 'V04-UTC002-A-NAN004.wav', type: 'coda_a', choices: ['lak', 'lat', 'lap', 'lah']},
        {audio: 'V01-UTC001-A-NAN004.wav', type: 'coda_a', choices: ['pak', 'pat', 'pap', 'pah']},
        {audio: 'V16-UTC006-A-NAN001.wav', type: 'coda_a', choices: ['tak', 'tat', 'tap', 'tah']},
        {audio: 'V07-UTC003-A-NAN001.wav', type: 'coda_a', choices: ['tak', 'tat', 'tap', 'tah']},
        {audio: 'V10-UTC004-A-NAN004.wav', type: 'coda_a', choices: ['tsak', 'tsat', 'tsap', 'tsah']},
        {audio: 'V19-UTC007-A-NAN003.wav', type: 'coda_a', choices: ['bak', 'bat', 'bap', 'bah']},
        {audio: 'V22-UTC008-A-NAN002.wav', type: 'coda_a', choices: ['lak', 'lat', 'lap', 'lah']},
        {audio: 'V13-UTC005-A-NAN004.wav', type: 'coda_a', choices: ['kak', 'kat', 'kap', 'kah']}
    ]
};

// UPDATED: Countries with correct naming
const countries = [
    "Mainland China / 中国大陆 / 中国本土", 
    "Hong Kong SAR / 香港特别行政区 / 香港特別行政区", 
    "Macau SAR / 澳门特别行政区 / マカオ特別行政区", 
    "Taiwan / 台湾地区 / 台湾地域", 
    "Japan / 日本 / 日本", "South Korea / 韓國 / 韓国", 
    "United States / 美國 / アメリカ", "United Kingdom / 英國 / イギリス", 
    "Canada / 加拿大 / カナダ", "Australia / 澳洲 / オーストラリア", 
    "Germany / 德國 / ドイツ", "France / 法國 / フランス", 
    "Italy / 義大利 / イタリア", "Spain / 西班牙 / スペイン", 
    "Netherlands / 荷蘭 / オランダ", "Belgium / 比利時 / ベルギー", 
    "Switzerland / 瑞士 / スイス", "Austria / 奧地利 / オーストリア", 
    "Sweden / 瑞典 / スウェーデン", "Norway / 挪威 / ノルウェー", 
    "Denmark / 丹麥 / デンマーク", "Finland / 芬蘭 / フィンランド", 
    "Poland / 波蘭 / ポーランド", "Russia / 俄羅斯 / ロシア", 
    "India / 印度 / インド", "Indonesia / 印尼 / インドネシア", 
    "Thailand / 泰國 / タイ", "Vietnam / 越南 / ベトナム", 
    "Philippines / 菲律賓 / フィリピン", "Malaysia / 馬來西亞 / マレーシア", 
    "Singapore / 新加坡 / シンガポール", "Brazil / 巴西 / ブラジル", 
    "Mexico / 墨西哥 / メキシコ", "Argentina / 阿根廷 / アルゼンチン", 
    "Chile / 智利 / チリ", "South Africa / 南非 / 南アフリカ", 
    "Egypt / 埃及 / エジプト", "Turkey / 土耳其 / トルコ", 
    "Saudi Arabia / 沙烏地阿拉伯 / サウジアラビア", 
    "United Arab Emirates / 阿聯酋 / アラブ首長国連邦", 
    "Israel / 以色列 / イスラエル", "New Zealand / 紐西蘭 / ニュージーランド", 
    "Ireland / 愛爾蘭 / アイルランド", "Portugal / 葡萄牙 / ポルトガル", 
    "Greece / 希臘 / ギリシャ", "Czech Republic / 捷克 / チェコ", 
    "Hungary / 匈牙利 / ハンガリー", "Romania / 羅馬尼亞 / ルーマニア", 
    "Other / 其他 / その他"
];

const regionsByCountry = {
    "Mainland China / 中国大陆 / 中国本土": ["Beijing / 北京 / 北京", "Shanghai / 上海 / 上海", "Tianjin / 天津 / 天津", "Chongqing / 重庆 / 重慶", "Hebei / 河北 / 河北省", "Shanxi / 山西 / 山西省", "Liaoning / 辽宁 / 遼寧省", "Jilin / 吉林 / 吉林省", "Heilongjiang / 黑龙江 / 黒竜江省", "Jiangsu / 江苏 / 江蘇省", "Zhejiang / 浙江 / 浙江省", "Anhui / 安徽 / 安徽省", "Fujian / 福建 / 福建省", "Jiangxi / 江西 / 江西省", "Shandong / 山东 / 山東省", "Henan / 河南 / 河南省", "Hubei / 湖北 / 湖北省", "Hunan / 湖南 / 湖南省", "Guangdong / 广东 / 広東省", "Guangxi / 广西 / 広西チワン族自治区", "Hainan / 海南 / 海南省", "Sichuan / 四川 / 四川省", "Guizhou / 贵州 / 貴州省", "Yunnan / 云南 / 雲南省", "Shaanxi / 陕西 / 陝西省", "Gansu / 甘肃 / 甘粛省", "Qinghai / 青海 / 青海省", "Inner Mongolia / 内蒙古 / 内モンゴル自治区", "Ningxia / 宁夏 / 寧夏回族自治区", "Xinjiang / 新疆 / 新疆ウイグル自治区", "Tibet / 西藏 / チベット自治区", "Other / 其他 / その他"],
    "Hong Kong SAR / 香港特别行政区 / 香港特別行政区": ["Hong Kong Island / 香港島 / 香港島", "Kowloon / 九龍 / 九龍", "New Territories / 新界 / 新界"],
    "Macau SAR / 澳门特别行政区 / マカオ特別行政区": ["Macau Peninsula / 澳門半島 / マカオ半島", "Taipa / 氹仔 / タイパ", "Coloane / 路環 / コロアン"],
    "Taiwan / 台湾地区 / 台湾地域": ["Taipei / 台北 / 台北", "New Taipei / 新北 / 新北", "Taoyuan / 桃園 / 桃園", "Taichung / 台中 / 台中", "Tainan / 台南 / 台南", "Kaohsiung / 高雄 / 高雄", "Keelung / 基隆 / 基隆", "Hsinchu / 新竹 / 新竹", "Chiayi / 嘉義 / 嘉義", "Changhua / 彰化 / 彰化", "Nantou / 南投 / 南投", "Yunlin / 雲林 / 雲林", "Pingtung / 屏東 / 屏東", "Yilan / 宜蘭 / 宜蘭", "Hualien / 花蓮 / 花蓮", "Taitung / 台東 / 台東", "Penghu / 澎湖 / 澎湖", "Kinmen / 金門 / 金門", "Lienchiang / 連江 / 連江", "Other / 其他 / その他"],
    "Japan / 日本 / 日本": ["Hokkaido / 北海道 / 北海道", "Aomori / 青森 / 青森県", "Iwate / 岩手 / 岩手県", "Miyagi / 宮城 / 宮城県", "Akita / 秋田 / 秋田県", "Yamagata / 山形 / 山形県", "Fukushima / 福島 / 福島県", "Ibaraki / 茨城 / 茨城県", "Tochigi / 栃木 / 栃木県", "Gunma / 群馬 / 群馬県", "Saitama / 埼玉 / 埼玉県", "Chiba / 千葉 / 千葉県", "Tokyo / 東京 / 東京都", "Kanagawa / 神奈川 / 神奈川県", "Niigata / 新潟 / 新潟県", "Toyama / 富山 / 富山県", "Ishikawa / 石川 / 石川県", "Fukui / 福井 / 福井県", "Yamanashi / 山梨 / 山梨県", "Nagano / 長野 / 長野県", "Gifu / 岐阜 / 岐阜県", "Shizuoka / 静岡 / 静岡県", "Aichi / 愛知 / 愛知県", "Mie / 三重 / 三重県", "Shiga / 滋賀 / 滋賀県", "Kyoto / 京都 / 京都府", "Osaka / 大阪 / 大阪府", "Hyogo / 兵庫 / 兵庫県", "Nara / 奈良 / 奈良県", "Wakayama / 和歌山 / 和歌山県", "Tottori / 鳥取 / 鳥取県", "Shimane / 島根 / 島根県", "Okayama / 岡山 / 岡山県", "Hiroshima / 広島 / 広島県", "Yamaguchi / 山口 / 山口県", "Tokushima / 徳島 / 徳島県", "Kagawa / 香川 / 香川県", "Ehime / 愛媛 / 愛媛県", "Kochi / 高知 / 高知県", "Fukuoka / 福岡 / 福岡県", "Saga / 佐賀 / 佐賀県", "Nagasaki / 長崎 / 長崎県", "Kumamoto / 熊本 / 熊本県", "Oita / 大分 / 大分県", "Miyazaki / 宮崎 / 宮崎県", "Kagoshima / 鹿児島 / 鹿児島県", "Okinawa / 沖縄 / 沖縄県"],
    "South Korea / 韓國 / 韓国": ["Seoul / 首爾 / ソウル / 서울", "Busan / 釜山 / 釜山 / 부산", "Incheon / 仁川 / 仁川 / 인천", "Daegu / 大邱 / 大邱 / 대구", "Daejeon / 大田 / 大田 / 대전", "Gwangju / 光州 / 光州 / 광주", "Ulsan / 蔚山 / 蔚山 / 울산", "Sejong / 世宗 / 世宗 / 세종", "Gyeonggi-do / 京畿道 / 京畿道 / 경기도", "Gangwon-do / 江原道 / 江原道 / 강원도", "Chungcheongbuk-do / 忠清北道 / 忠清北道 / 충청북도", "Chungcheongnam-do / 忠清南道 / 忠清南道 / 충청남도", "Jeollabuk-do / 全羅北道 / 全羅北道 / 전라북도", "Jeollanam-do / 全羅南道 / 全羅南道 / 전라남도", "Gyeongsangbuk-do / 慶尚北道 / 慶尚北道 / 경상북도", "Gyeongsangnam-do / 慶尚南道 / 慶尚南道 / 경상남도", "Jeju / 濟州 / 済州 / 제주", "Other / 其他 / その他"],
    "United States / 美國 / アメリカ": ["Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming", "Other"],
    "United Kingdom / 英國 / イギリス": ["England / 英格蘭 / イングランド", "Scotland / 蘇格蘭 / スコットランド", "Wales / 威爾斯 / ウェールズ", "Northern Ireland / 北愛爾蘭 / 北アイルランド", "Other / 其他 / その他"],
    "Canada / 加拿大 / カナダ": ["Alberta", "British Columbia", "Manitoba", "New Brunswick", "Newfoundland and Labrador", "Northwest Territories", "Nova Scotia", "Nunavut", "Ontario", "Prince Edward Island", "Quebec", "Saskatchewan", "Yukon", "Other"],
    "Australia / 澳洲 / オーストラリア": ["New South Wales", "Victoria", "Queensland", "South Australia", "Western Australia", "Tasmania", "Northern Territory", "Australian Capital Territory", "Other"],
    "Germany / 德國 / ドイツ": ["Baden-Württemberg", "Bavaria", "Berlin", "Brandenburg", "Bremen", "Hamburg", "Hesse", "Lower Saxony", "Mecklenburg-Vorpommern", "North Rhine-Westphalia", "Rhineland-Palatinate", "Saarland", "Saxony", "Saxony-Anhalt", "Schleswig-Holstein", "Thuringia", "Other"],
    "France / 法國 / フランス": ["Île-de-France", "Auvergne-Rhône-Alpes", "Provence-Alpes-Côte d'Azur", "Nouvelle-Aquitaine", "Occitanie", "Hauts-de-France", "Brittany", "Normandy", "Grand Est", "Pays de la Loire", "Centre-Val de Loire", "Bourgogne-Franche-Comté", "Corsica", "Other"],
    "India / 印度 / インド": ["Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal", "Delhi", "Other"]
};

const languages = ["Arabic / 阿拉伯語 / アラビア語 / العربية", "Bengali / 孟加拉語 / ベンガル語 / বাংলা", "Cantonese / 粵語 / 広東語", "Czech / 捷克語 / チェコ語 / Čeština", "Danish / 丹麥語 / デンマーク語 / Dansk", "Dutch / 荷蘭語 / オランダ語 / Nederlands", "English / 英語 / 英語", "Finnish / 芬蘭語 / フィンランド語 / Suomi", "French / 法語 / フランス語 / Français", "German / 德語 / ドイツ語 / Deutsch", "Greek / 希臘語 / ギリシャ語 / Ελληνικά", "Hebrew / 希伯來語 / ヘブライ語 / עברית", "Hindi / 印地語 / ヒンディー語 / हिन्दी", "Hungarian / 匈牙利語 / ハンガリー語 / Magyar", "Indonesian / 印尼語 / インドネシア語 / Bahasa Indonesia", "Italian / 義大利語 / イタリア語 / Italiano", "Japanese / 日語 / 日本語 / 日本語", "Korean / 韓語 / 韓国語 / 한국어", "Malay / 馬來語 / マレー語 / Bahasa Melayu", "Mandarin / 普通話 / 標準中国語", "Min Nan / Taiwanese / 閩南語/台語 / 閩南語/台湾語", "Norwegian / 挪威語 / ノルウェー語 / Norsk", "Persian / 波斯語 / ペルシア語 / فارسی", "Polish / 波蘭語 / ポーランド語 / Polski", "Portuguese / 葡萄牙語 / ポルトガル語 / Português", "Punjabi / 旁遮普語 / パンジャブ語 / ਪੰਜਾਬੀ", "Romanian / 羅馬尼亞語 / ルーマニア語 / Română", "Russian / 俄語 / ロシア語 / Русский", "Spanish / 西班牙語 / スペイン語 / Español", "Swahili / 史瓦希里語 / スワヒリ語 / Kiswahili", "Swedish / 瑞典語 / スウェーデン語 / Svenska", "Tagalog / 他加祿語 / タガログ語", "Tamil / 泰米爾語 / タミル語 / தமிழ்", "Telugu / 泰盧固語 / テルグ語 / తెలుగు", "Thai / 泰語 / タイ語 / ไทย", "Turkish / 土耳其語 / トルコ語 / Türkçe", "Ukrainian / 烏克蘭語 / ウクライナ語 / Українська", "Urdu / 烏爾都語 / ウルドゥー語 / اردو", "Vietnamese / 越南語 / ベトナム語 / Tiếng Việt", "Wu Chinese / 吳語 / 呉語", "Yue Chinese / 粵語 / 粤語", "Other / 其他 / その他"];

function getTimestamp() {
    const dt = new Date();
    return `${dt.getFullYear()}${String(dt.getMonth()+1).padStart(2,'0')}${String(dt.getDate()).padStart(2,'0')}_${String(dt.getHours()).padStart(2,'0')}${String(dt.getMinutes()).padStart(2,'0')}${String(dt.getSeconds()).padStart(2,'0')}`;
}

function downloadCSV(csv, filename) {
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

function updateRegions() {
    const country = document.getElementById('q3_country').value;
    const regionSelect = document.getElementById('q3_region');
    regionSelect.innerHTML = '<option value="">-- Select Region / 選擇地區 / 地域を選択 --</option>';
    const regions = regionsByCountry[country] || ['Other / 其他 / その他'];
    regions.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        regionSelect.appendChild(opt);
    });
    window.surveyData.Q3_Country = country;
}

function updateL1Selects() {
    const num = parseInt(document.getElementById('q4_num').value) || 0;
    const container = document.getElementById('l1-select-container');
    container.innerHTML = '';
    window.surveyData.Q4_Num_L1 = num.toString();
    for (let i = 0; i < num; i++) {
        const div = document.createElement('div');
        div.className = 'language-select-item';
        div.innerHTML = `<label>First Language ${i+1} / 第一語言${i+1} / 第一言語${i+1}:</label><select id="q4_lang_${i}" onchange="updateL1Languages()" required><option value="">-- Select Language / 選擇語言 / 言語を選択 --</option>${languages.map(l => `<option value="${l}">${l}</option>`).join('')}</select>`;
        container.appendChild(div);
    }
}

function updateL1Languages() {
    const numLangs = parseInt(document.getElementById('q4_num').value) || 0;
    const langsList = [];
    for (let i = 0; i < numLangs; i++) {
        const langElem = document.getElementById(`q4_lang_${i}`);
        if (langElem && langElem.value) {
            langsList.push(langElem.value);
        }
    }
    window.surveyData.Q4_L1_Languages = langsList.join('; ') || 'None';
}

function updateLanguageSelects() {
    const num = parseInt(document.getElementById('q5_num').value) || 0;
    const container = document.getElementById('language-select-container');
    container.innerHTML = '';
    window.surveyData.Q5_Num_Languages = num.toString();
    for (let i = 0; i < num; i++) {
        const div = document.createElement('div');
        div.className = 'language-select-item';
        div.innerHTML = `<label>Language ${i+1} / 語言${i+1} / 言語${i+1}:</label><select id="q5_lang_${i}" onchange="updateLanguages()" required><option value="">-- Select Language / 選擇語言 / 言語を選択 --</option>${languages.map(l => `<option value="${l}">${l}</option>`).join('')}</select>`;
        container.appendChild(div);
    }
}

function updateLanguages() {
    const numLangs = parseInt(document.getElementById('q5_num').value) || 0;
    const langsList = [];
    for (let i = 0; i < numLangs; i++) {
        const langElem = document.getElementById(`q5_lang_${i}`);
        if (langElem && langElem.value) {
            langsList.push(langElem.value);
        }
    }
    window.surveyData.Q5_Languages = langsList.join('; ') || 'None';
}

function validateSurvey() {
    if (!window.surveyData.Q1_Age || !window.surveyData.Q2_Gender || 
        !window.surveyData.Q3_Country || !window.surveyData.Q3_Region ||
        !window.surveyData.Q4_Num_L1 || !window.surveyData.Q5_Num_Languages ||
        !window.surveyData.Q6_Music_Years || !window.surveyData.Q7_Absolute_Pitch ||
        !window.surveyData.Q8_Pronunciation_Training) {
        alert('Please complete all required fields! / 請填寫所有必填欄位！ / すべての必須項目を入力してください！');
        return false;
    }
    
    const numL1 = parseInt(window.surveyData.Q4_Num_L1) || 0;
    if (numL1 > 0 && window.surveyData.Q4_L1_Languages === '') {
        alert('Please select all first languages! / 請選擇所有第一語言！ / すべての第一言語を選択してください！');
        return false;
    }
    
    const numLangs = parseInt(window.surveyData.Q5_Num_Languages) || 0;
    if (numLangs > 0 && window.surveyData.Q5_Languages === '') {
        alert('Please select all other languages! / 請選擇所有其他語言！ / すべての他の言語を選択してください！');
        return false;
    }
    
    return true;
}

// USING PILOT1'S SIMPLE AUDIO METHOD (that works!)
function createPerceptionTrial(stimulus, trialNum, totalTrials, sectionName, isPractice) {
    let choices, choiceLabels, prompt;
    
    if (stimulus.type === 'tone') {
        choices = ['Low', 'High'];
        choiceLabels = ['A. Low', 'B. High'];
        prompt = '<p><strong>Is this Low or High tone? / 這是低音還是高音？ / これは低い音ですか、高い音ですか？</strong></p>';
    } else if (stimulus.type === 'coda_a') {
        choices = stimulus.choices;
        choiceLabels = choices.map((c, i) => String.fromCharCode(65 + i) + '. ' + c);
        prompt = '<p><strong>Which syllable do you hear? / 你聽到哪個音節？ / どの音節が聞こえますか？</strong></p>';
    } else {
        choices = ['ak', 'ap', 'at', 'ah'];
        choiceLabels = ['A. ak', 'B. ap', 'C. at', 'D. ah'];
        prompt = '<p><strong>Which coda do you hear? / 你聽到哪個尾音？ / どの末子音が聞こえますか？</strong></p>';
    }
    
    const trialId = 'trial_' + Math.random().toString(36).substr(2, 9);
    const audioPath = 'sounds/' + stimulus.audio;
    
    const trial = {
        type: 'html-button-response',
        stimulus: function() {
            let header = '';
            if (!isPractice) {
                const percentage = Math.round((trialNum / totalTrials) * 100);
                header = `<div class="trial-header"><div class="trial-number">Question ${trialNum} of ${totalTrials} / 問題 ${trialNum}/${totalTrials} / 問題 ${trialNum}/${totalTrials}</div><div class="progress-text">Progress / 進度 / 進捗: ${percentage}%</div></div>`;
            }
            
            const maxPlays = isPractice ? 999 : 2;
            const audioPlayer = `
                <div class="audio-player">
                    <audio id="${trialId}" preload="auto">
                        <source src="${audioPath}" type="audio/wav">
                        Your browser does not support the audio element.
                    </audio>
                    <button class="play-button" id="btn_${trialId}" data-played="0" onclick="
                        const audio = document.getElementById('${trialId}');
                        const btn = document.getElementById('btn_${trialId}');
                        const count = document.getElementById('count_${trialId}');
                        const errorMsg = document.getElementById('error_${trialId}');
                        
                        let played = parseInt(btn.getAttribute('data-played') || '0');
                        
                        if (${isPractice} || played < 2) {
                            audio.currentTime = 0;
                            
                            const playPromise = audio.play();
                            
                            if (playPromise !== undefined) {
                                playPromise.then(() => {
                                    if (errorMsg) errorMsg.style.display = 'none';
                                    
                                    if (!${isPractice}) {
                                        played++;
                                        btn.setAttribute('data-played', played);
                                        count.textContent = 'Played / 已播放 / 再生済: ' + played + '/2';
                                        
                                        if (played >= 2) {
                                            btn.disabled = true;
                                        }
                                    }
                                }).catch((error) => {
                                    console.error('Playback error:', error);
                                    if (errorMsg) {
                                        errorMsg.textContent = 'Audio playback error. Please refresh the page. / 音頻播放錯誤，請刷新頁面。 / 音声再生エラー。ページを更新してください。';
                                        errorMsg.style.display = 'block';
                                    }
                                });
                            }
                        }
                    ">
                        <span class="play-icon">▶</span>
                    </button>
                    <p id="count_${trialId}">Played / 已播放 / 再生済: 0/${maxPlays}</p>
                    <div id="error_${trialId}" class="error-message" style="display:none;"></div>
                </div>
            `;
            
            return header + audioPlayer + prompt;
        },
        choices: choiceLabels,
        data: { 
            question_number: trialNum,
            section: sectionName, 
            stimulus: stimulus.audio, 
            task_type: stimulus.type, 
            is_practice: isPractice 
        },
        on_finish: function(data) {
            data.response = choices[data.button_pressed];
        }
    };
    
    if (isPractice && stimulus.answer) {
        return [trial, {
            type: 'html-button-response',
            stimulus: function() {
                const lastTrial = jsPsych.data.get().last(1).values()[0];
                const correct = lastTrial.response === stimulus.answer;
                return correct ? 
                    `<div class="feedback-correct">✓ Correct! / 正確！ / 正解！</div><div class="feedback-answer">You selected / 您選擇了 / 選択: ${lastTrial.response}</div><p>Click "Continue" / 點擊「繼續」 / 「続ける」をクリック</p>` : 
                    `<div class="feedback-incorrect">✗ Incorrect / 不正確 / 不正解</div><div class="feedback-answer">You selected / 您選擇了 / 選択: ${lastTrial.response}</div><div class="feedback-answer">Correct answer / 正確答案 / 正解: ${stimulus.answer}</div><p>Click "Continue" / 點擊「繼續」 / 「続ける」をクリック</p>`;
            },
            choices: ['Continue / 繼續 / 続ける'],
            data: { is_feedback: true }
        }];
    }
    return trial;
}

var timeline = [];

timeline.push({
    type: 'instructions',
    pages: [
        `<h1>Welcome to the Hokkien Speech Perception Test<br>歡迎參加閩南語語音聽覺測試<br>閩南語音声知覚テストへようこそ</h1>
        <div class="instruction-text">
            <div class="lang-section">
                <h3>English</h3>
                <p>Thank you for participating!</p>
                <p>This test will take approximately <strong>8-10 minutes</strong>.</p>
                
                <div class="requirement-box">
                    <strong>Environment Requirements:</strong><br>
                    ✓ <strong>No known hearing problems</strong><br>
                    ✓ Wearing <strong>headphones</strong><br>
                    ✓ Using <strong>computer or tablet</strong><br>
                    ✓ In a <strong>quiet environment</strong>
                </div>
                
                <div class="consent-box">
                    <strong>Consent and Privacy:</strong><br>
                    • This experiment is <strong>voluntary and anonymous</strong><br>
                    • Your responses will be kept confidential<br>
                    • You may <strong>stop at any point</strong><br>
                    • No personal identifying information will be collected
                </div>
            </div>
            
            <div class="lang-section">
                <h3>中文</h3>
                <p>感謝您的參與！</p>
                <p>此測試約需 <strong>8-10 分鐘</strong>。</p>
                
                <div class="requirement-box">
                    <strong>環境要求：</strong><br>
                    ✓ <strong>無已知聽力問題</strong><br>
                    ✓ 佩戴<strong>耳機</strong><br>
                    ✓ 使用<strong>電腦或平板</strong><br>
                    ✓ 在<strong>安靜的環境</strong>中
                </div>
                
                <div class="consent-box">
                    <strong>同意與隱私：</strong><br>
                    • 本實驗為<strong>自願且匿名</strong><br>
                    • 您的回答將保密<br>
                    • 您可<strong>隨時停止</strong><br>
                    • 不會收集個人識別資訊
                </div>
            </div>
            
            <div class="lang-section">
                <h3>日本語</h3>
                <p>ご参加ありがとうございます！</p>
                <p>このテストは約<strong>8〜10分</strong>かかります。</p>
                
                <div class="requirement-box">
                    <strong>環境要件：</strong><br>
                    ✓ <strong>既知の聴覚問題がない</strong><br>
                    ✓ <strong>ヘッドフォン</strong>を着用<br>
                    ✓ <strong>コンピュータまたはタブレット</strong>を使用<br>
                    ✓ <strong>静かな環境</strong>にいる
                </div>
                
                <div class="consent-box">
                    <strong>同意とプライバシー：</strong><br>
                    • この実験は<strong>任意かつ匿名</strong>です<br>
                    • 回答は秘密にされます<br>
                    • <strong>いつでも中止</strong>できます<br>
                    • 個人を特定する情報は収集されません
                </div>
            </div>
            
            <p style="text-align:center; margin-top:30px;">
                <strong>Click "Next" to continue / 點擊「下一步」繼續 / 「次へ」をクリックして続行</strong>
            </p>
        </div>`
    ],
    show_clickable_nav: true,
    button_label_next: 'Next / 下一步 / 次へ'
});

timeline.push({
    type: 'html-button-response',
    stimulus: function() {
        let html = '<div class="survey-form">';
        html += '<h1>Background Survey / 背景調查 / 背景調査</h1>';
        html += '<p style="margin-bottom:30px;">Please answer all questions / 請回答所有問題 / すべての質問に答えてください (<span style="color:red;">*</span>)</p>';
        
        // Q1
        html += '<div class="form-group">';
        html += '<label for="q1_age">Q1. What is your age? / 您的年齡？ / 年齢は？ <span style="color:red;">*</span></label>';
        html += '<small>Select a number / 選擇數字 / 番号を選択 (0-100)</small>';
        html += '<select id="q1_age" onchange="window.surveyData.Q1_Age=this.value;" required><option value="">-- Select Age / 選擇年齡 / 年齢を選択 --</option>';
        for (let i = 0; i <= 100; i++) {
            html += `<option value="${i}">${i}</option>`;
        }
        html += '</select></div>';
        
        // Q2
        html += '<div class="form-group">';
        html += '<label for="q2_gender">Q2. What is your gender? / 您的性別？ / 性別は？ <span style="color:red;">*</span></label>';
        html += '<select id="q2_gender" onchange="window.surveyData.Q2_Gender=this.value;" required>';
        html += '<option value="">-- Select / 選擇 / 選択 --</option>';
        html += '<option value="Male">Male / 男性 / 男性</option>';
        html += '<option value="Female">Female / 女性 / 女性</option>';
        html += '<option value="Prefer not to say">Prefer not to say / 不願透露 / 答えたくない</option>';
        html += '</select></div>';
        
        // Q3
        html += '<div class="form-group">';
        html += '<label for="q3_country">Q3. Where do you come from? / 您來自哪裡？ / 出身地は？ <span style="color:red;">*</span></label>';
        html += '<small>Select a country or area and region / 選擇國家或地區和區域 / 国または地域と地域を選択</small>';
        html += '<select id="q3_country" onchange="updateRegions()" required><option value="">-- Select Country or Area / 選擇國家或地區 / 国または地域を選択 --</option>';
        countries.forEach(c => html += `<option value="${c}">${c}</option>`);
        html += '</select>';
        html += '<select id="q3_region" onchange="window.surveyData.Q3_Region=this.value;" style="margin-top:10px;" required>';
        html += '<option value="">-- First select a country / 先選擇國家 / まず国を選択 --</option>';
        html += '</select></div>';
        
        // Q4
        html += '<div class="form-group">';
        html += '<label for="q4_num">Q4. Which language(s) did you mainly use before age 12?<br>您12歲前主要使用哪種語言？<br>12歳までに主に使用した言語は？ <span style="color:red;">*</span></label>';
        html += '<small>Select the number of first languages / 選擇第一語言數量 / 第一言語の数を選択</small>';
        html += '<span class="explanation">Must be fluent, use as mother tongue / 必須流利，作為母語使用 / 流暢で母語として使用</span>';
        html += '<select id="q4_num" onchange="updateL1Selects()" required><option value="">-- Select Number / 選擇數量 / 数を選択 --</option>';
        for (let i = 1; i <= 10; i++) {
            html += `<option value="${i}">${i}</option>`;
        }
        html += '</select><div id="l1-select-container" class="language-select-container"></div></div>';
        
        // Q5 - UPDATED
        html += '<div class="form-group">';
        html += '<label for="q5_num">Q5. How many OTHER languages can you speak fluently (besides your first language(s))?<br>除了母語外，您還能流利使用多少種其他語言？<br>母語以外に流暢に話せる言語は何語ですか？ <span style="color:red;">*</span></label>';
        html += '<small>Select the number (excluding languages from Q4) / 選擇數量（不包括第四題的語言） / 数を選択（Q4の言語を除く）</small>';
        html += '<select id="q5_num" onchange="updateLanguageSelects()" required>';
        html += '<option value="">-- Select Number / 選擇數量 / 数を選択 --</option>';
        html += '<option value="0">0 (None / 無 / なし)</option>';
        for (let i = 1; i <= 10; i++) {
            html += `<option value="${i}">${i}</option>`;
        }
        html += '</select><div id="language-select-container" class="language-select-container"></div></div>';
        
        // Q6
        html += '<div class="form-group">';
        html += '<label for="q6_music">Q6. How many years of formal musical training?<br>您有多少年正式音樂訓練？<br>正式な音楽訓練は何年？ <span style="color:red;">*</span></label>';
        html += '<small>Select a number / 選擇數字 / 番号を選択 (0-50)</small>';
        html += '<span class="explanation">e.g., learning an instrument or vocal music / 例如：學習樂器或聲樂 / 例：楽器や声楽のレッスン</span>';
        html += '<select id="q6_music" onchange="window.surveyData.Q6_Music_Years=this.value;" required>';
        html += '<option value="">-- Select Years / 選擇年數 / 年数を選択 --</option>';
        for (let i = 0; i <= 50; i++) {
            html += `<option value="${i}">${i}</option>`;
        }
        html += '</select></div>';
        
        // Q7
        html += '<div class="form-group">';
        html += '<label for="q7_pitch">Q7. Do you have absolute pitch?<br>您有絕對音感嗎？<br>絶対音感はありますか？ <span style="color:red;">*</span></label>';
        html += '<select id="q7_pitch" onchange="window.surveyData.Q7_Absolute_Pitch=this.value;" required>';
        html += '<option value="">-- Select / 選擇 / 選択 --</option>';
        html += '<option value="YES">YES / 是 / はい</option>';
        html += '<option value="NO">NO / 否 / いいえ</option>';
        html += '<option value="NOT SURE">NOT SURE / 不確定 / わからない</option>';
        html += '</select></div>';
        
        // Q8
        html += '<div class="form-group">';
        html += '<label for="q8_training">Q8. Have you received formal pronunciation training?<br>您接受過正式發音訓練嗎？<br>正式な発音訓練を受けましたか？ <span style="color:red;">*</span></label>';
        html += '<span class="explanation">e.g., English pronunciation course / 例如：英語發音課程 / 例：英語の発音コース</span>';
        html += '<select id="q8_training" onchange="window.surveyData.Q8_Pronunciation_Training=this.value;" required>';
        html += '<option value="">-- Select / 選擇 / 選択 --</option>';
        html += '<option value="YES">YES / 是 / はい</option>';
        html += '<option value="NO">NO / 否 / いいえ</option>';
        html += '</select></div>';
        
        html += '</div>';
        return html;
    },
    choices: ['Start Test / 開始測試 / テスト開始'],
    data: { is_survey: true },
    on_load: function() {
        const btn = document.querySelector('.jspsych-btn');
        if (btn) {
            btn.onclick = function(e) {
                if (!validateSurvey()) {
                    e.stopPropagation();
                    e.preventDefault();
                    return false;
                }
            };
        }
    }
});

let trialNum = 1;
let totalTrials = 16 + 16 + 8;

timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 1: Tone Practice / 第一部分：音調練習 / パート1：音調練習</h1><div class="instruction-text"><div class="lang-section"><h3>English</h3><p>Practice identifying <strong>Low</strong> vs <strong>High</strong> tones.</p><p>After each answer, you'll see if you were correct.</p><p>You can replay audio as many times as you want.</p></div><div class="lang-section"><h3>中文</h3><p>練習識別<strong>低音</strong>與<strong>高音</strong>。</p><p>每次回答後，您會看到答案是否正確。</p><p>您可以無限次重播音頻。</p></div><div class="lang-section"><h3>日本語</h3><p><strong>低音</strong>と<strong>高音</strong>を識別する練習です。</p><p>各回答の後、正解かどうかがわかります。</p><p>音声は何度でも再生できます。</p></div><p style="text-align:center; margin-top:20px;"><strong>Click "Start" / 點擊「開始」 / 「開始」をクリック</strong></p></div>`],
    show_clickable_nav: true,
    button_label_next: 'Start / 開始 / 開始'
});

testSections.tone_practice.forEach(stim => { 
    const trials = createPerceptionTrial(stim, null, totalTrials, 'Tone_Practice', true); 
    if (Array.isArray(trials)) trials.forEach(t => timeline.push(t)); 
    else timeline.push(trials); 
});

timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 2: Tone Test / 第二部分：音調測試 / パート2：音調テスト</h1><div class="instruction-text"><div class="lang-section"><h3>English</h3><p>Continue identifying Low vs High tones.</p><p>You will NOT see correct answers.</p><p><strong>Important: Each audio can only be played TWICE!</strong></p></div><div class="lang-section"><h3>中文</h3><p>繼續識別低音與高音。</p><p>您將不會看到正確答案。</p><p><strong>重要：每個音頻只能播放兩次！</strong></p></div><div class="lang-section"><h3>日本語</h3><p>低音と高音の識別を続けます。</p><p>正解は表示されません。</p><p><strong>重要：各音声は2回のみ再生できます！</strong></p></div><p style="text-align:center; margin-top:20px;"><strong>Click "Start" / 點擊「開始」 / 「開始」をクリック</strong></p></div>`],
    show_clickable_nav: true,
    button_label_next: 'Start / 開始 / 開始'
});

testSections.tone_main.forEach(stim => timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Tone_Main', false)));

timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 3: Coda Practice / 第三部分：尾音練習 / パート3：末子音練習</h1><div class="instruction-text"><div class="lang-section"><h3>English</h3><p>Practice identifying word-final consonants (codas).</p><p>Listen for: <strong>ak, ap, at, or ah</strong></p><p>You can replay audio as many times as you want.</p></div><div class="lang-section"><h3>中文</h3><p>練習識別詞尾輔音（尾音）。</p><p>聽辨：<strong>ak、ap、at 或 ah</strong></p><p>您可以無限次重播音頻。</p></div><div class="lang-section"><h3>日本語</h3><p>語末子音（末子音）を識別する練習です。</p><p>聞き取る音：<strong>ak、ap、at、またはah</strong></p><p>音声は何度でも再生できます。</p></div><p style="text-align:center; margin-top:20px;"><strong>Click "Start" / 點擊「開始」 / 「開始」をクリック</strong></p></div>`],
    show_clickable_nav: true,
    button_label_next: 'Start / 開始 / 開始'
});

testSections.coda_practice.forEach(stim => { 
    const trials = createPerceptionTrial(stim, null, totalTrials, 'Coda_Practice', true); 
    if (Array.isArray(trials)) trials.forEach(t => timeline.push(t)); 
    else timeline.push(trials); 
});

timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 4: Coda Test - Part 1 / 第四部分：尾音測試 - 第1部分 / パート4：末子音テスト - パート1</h1><div class="instruction-text"><div class="lang-section"><h3>English</h3><p>Continue identifying codas: <strong>ak, ap, at, or ah</strong></p><p><strong>Important: Each audio can only be played TWICE!</strong></p></div><div class="lang-section"><h3>中文</h3><p>繼續識別尾音：<strong>ak、ap、at 或 ah</strong></p><p><strong>重要：每個音頻只能播放兩次！</strong></p></div><div class="lang-section"><h3>日本語</h3><p>末子音の識別を続けます：<strong>ak、ap、at、またはah</strong></p><p><strong>重要：各音声は2回のみ再生できます！</strong></p></div><p style="text-align:center; margin-top:20px;"><strong>Click "Start" / 點擊「開始」 / 「開始」をクリック</strong></p></div>`],
    show_clickable_nav: true,
    button_label_next: 'Start / 開始 / 開始'
});

testSections.coda_main_p.forEach(stim => timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Coda_Main_P', false)));

timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 5: Coda Test - Part 2 / 第五部分：尾音測試 - 第2部分 / パート5：末子音テスト - パート2</h1><div class="instruction-text"><div class="lang-section"><h3>English</h3><p>In this section, you'll hear different consonant+coda combinations.</p><p>Listen carefully to the ENTIRE syllable.</p><p><strong>Important: Each audio can only be played TWICE!</strong></p></div><div class="lang-section"><h3>中文</h3><p>在這部分，您將聽到不同的輔音+尾音組合。</p><p>請仔細聽整個音節。</p><p><strong>重要：每個音頻只能播放兩次！</strong></p></div><div class="lang-section"><h3>日本語</h3><p>このセクションでは、さまざまな子音+末子音の組み合わせを聞きます。</p><p>音節全体を注意深く聞いてください。</p><p><strong>重要：各音声は2回のみ再生できます！</strong></p></div><p style="text-align:center; margin-top:20px;"><strong>Click "Start" / 點擊「開始」 / 「開始」をクリック</strong></p></div>`],
    show_clickable_nav: true,
    button_label_next: 'Start / 開始 / 開始'
});

testSections.coda_main_a.forEach(stim => timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Coda_Main_A', false)));

timeline.push({
    type: 'instructions',
    pages: [`<h1>Test Complete! / 測試完成！ / テスト完了！</h1><div class="instruction-text"><div class="lang-section"><h3>English</h3><p>Thank you for your participation!</p><p>Click "Finish" to save your data.</p><div class="email-reminder"><strong>⚠️ Important:</strong> Please send your test results to:<br><strong style="font-size:18px;">c281769x@icu.ac.jp</strong></div></div><div class="lang-section"><h3>中文</h3><p>感謝您的參與！</p><p>點擊「完成」以儲存您的資料。</p><div class="email-reminder"><strong>⚠️ 重要提示：</strong>請將測試結果發送至：<br><strong style="font-size:18px;">c281769x@icu.ac.jp</strong></div></div><div class="lang-section"><h3>日本語</h3><p>ご参加ありがとうございました！</p><p>「完了」をクリックしてデータを保存してください。</p><div class="email-reminder"><strong>⚠️ 重要：</strong>テスト結果を以下に送信してください：<br><strong style="font-size:18px;">c281769x@icu.ac.jp</strong></div></div></div>`],
    show_clickable_nav: true,
    button_label_next: 'Finish / 完成 / 完了'
});

jsPsych.init({
    timeline: timeline,
    show_progress_bar: true,
    on_finish: function() {
        var allData = jsPsych.data.get().values();
        var perceptionData = allData.filter(t => 
            t.trial_type === 'html-button-response' && 
            t.is_practice === false &&
            !t.is_feedback &&
            !t.is_survey &&
            t.question_number !== null &&
            t.question_number !== undefined &&
            !isNaN(t.question_number)
        );
        
        var csvContent = "Question_Number,Response\n";
        
        csvContent += `Q1_Age,${window.surveyData.Q1_Age}\n`;
        csvContent += `Q2_Gender,${window.surveyData.Q2_Gender}\n`;
        csvContent += `Q3_Country,${window.surveyData.Q3_Country}\n`;
        csvContent += `Q3_Region,${window.surveyData.Q3_Region}\n`;
        csvContent += `Q4_Num_L1,${window.surveyData.Q4_Num_L1}\n`;
        csvContent += `Q4_L1_Languages,"${window.surveyData.Q4_L1_Languages}"\n`;
        csvContent += `Q5_Num_Languages,${window.surveyData.Q5_Num_Languages}\n`;
        csvContent += `Q5_Languages,"${window.surveyData.Q5_Languages}"\n`;
        csvContent += `Q6_Music_Years,${window.surveyData.Q6_Music_Years}\n`;
        csvContent += `Q7_Absolute_Pitch,${window.surveyData.Q7_Absolute_Pitch}\n`;
        csvContent += `Q8_Pronunciation_Training,${window.surveyData.Q8_Pronunciation_Training}\n`;
        
        perceptionData.forEach(trial => {
            csvContent += `${parseInt(trial.question_number) + 10},${trial.response}\n`;
        });
        
        downloadCSV(csvContent, 'kpth_perception_' + getTimestamp() + '.csv');
        
        fetch(GOOGLE_SHEETS_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'}, body: csvContent }).then(() => console.log('Uploaded')).catch(e => console.log('Upload error:', e));
        
        document.querySelector('#jspsych-content').innerHTML = `<h1>Data saved! / 資料已儲存！ / データ保存完了！</h1><p>Thank you! / 謝謝！ / ありがとうございました！</p><div class="email-reminder" style="max-width:600px; margin:20px auto;"><strong>⚠️ IMPORTANT REMINDER / 重要提示 / 重要なお知らせ:</strong><br><br>Please send your test results file to:<br>請將測試結果文件發送至：<br>テスト結果ファイルを送信してください：<br><br><strong style="font-size:20px; color:#155724;">c281769x@icu.ac.jp</strong></div><p style="margin-top:20px;">You may close this page / 您可以關閉此頁面 / このページを閉じてください</p>`;
    }
});

console.log('=== FINAL VERSION ===');
console.log('Using pilot1 simple audio method (that works!)');
console.log('With pilot1.5 audio files');
console.log('All UI changes applied');

</script>
</html>
