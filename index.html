<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kpth Tone Perception Test</title>
    
    <!-- Load jsPsych -->
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/jspsych-instructions.js"></script>
    <script src="jspsych/jspsych-html-button-response.js"></script>
    <script src="jspsych/jspsych-survey-text.js"></script>
    <script src="jspsych/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych/jspsych-survey-html-form.js"></script>
    <link href="css/jspsych.css" rel="stylesheet" type="text/css">
    
    <style>
        body { background-color: #f5f5f5; }
        .jspsych-btn { margin: 10px; padding: 15px 30px; font-size: 18px; }
        .jspsych-content-wrapper { width: 85%; max-width: 900px; }
        .jspsych-content { padding: 30px; }
        h1 { color: #333; margin-bottom: 20px; }
        .instruction-text { text-align: left; line-height: 1.6; font-size: 16px; }
        
        .audio-player { text-align: center; margin: 30px 0; }
        .play-button {
            background-color: #4CAF50; border: none; color: white; padding: 20px;
            text-align: center; display: inline-block; font-size: 16px; cursor: pointer;
            border-radius: 50%; width: 80px; height: 80px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s;
        }
        .play-button:hover { background-color: #45a049; box-shadow: 0 6px 12px rgba(0,0,0,0.3); transform: scale(1.05); }
        .play-button:active { transform: scale(0.95); }
        .play-icon { font-size: 32px; }
        
        .trial-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            color: #666;
        }
        .trial-number {
            font-weight: bold;
            font-size: 20px;
            color: #333;
        }
        .progress-text {
            font-size: 16px;
            color: #888;
            margin-top: 5px;
        }
        
        .feedback-correct {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }
        .feedback-incorrect {
            color: #f44336;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }
        .feedback-answer {
            font-size: 18px;
            margin: 10px 0;
        }
        
        .survey-question {
            margin: 25px 0;
            text-align: left;
        }
        .survey-question label {
            font-size: 16px;
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
        }
        .survey-question input[type="number"],
        .survey-question input[type="text"],
        .survey-question select {
            width: 100%;
            max-width: 400px;
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 5px;
        }
        .survey-question small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 14px;
        }
        
        .requirement-box {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            font-size: 15px;
        }
        .requirement-box strong {
            color: #856404;
        }
        
        #language-container {
            margin-top: 10px;
        }
        .language-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .language-item select {
            width: 100%;
            max-width: 400px;
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .remove-language-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }
        .remove-language-btn:hover {
            background-color: #c82333;
        }
        .add-language-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 16px;
        }
        .add-language-btn:hover {
            background-color: #218838;
        }
    </style>
</head>

<body>
    <div id="jspsych-target"></div>
</body>

<script>

/******************************************************************************
 * Google Sheets Configuration
 ******************************************************************************/

const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';

/******************************************************************************
 * Country and Language Data
 ******************************************************************************/

const countries = [
    "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Argentina", "Armenia", "Australia",
    "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium",
    "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei",
    "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada", "Chad", "Chile", "China",
    "Colombia", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Dominican Republic",
    "Ecuador", "Egypt", "El Salvador", "Estonia", "Ethiopia", "Fiji", "Finland", "France", "Georgia",
    "Germany", "Ghana", "Greece", "Guatemala", "Haiti", "Honduras", "Hong Kong", "Hungary", "Iceland",
    "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan",
    "Kazakhstan", "Kenya", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Libya", "Lithuania",
    "Luxembourg", "Macau", "Madagascar", "Malaysia", "Maldives", "Mali", "Malta", "Mexico", "Moldova",
    "Monaco", "Mongolia", "Montenegro", "Morocco", "Myanmar", "Nepal", "Netherlands", "New Zealand",
    "Nicaragua", "Niger", "Nigeria", "North Korea", "Norway", "Oman", "Pakistan", "Palestine", "Panama",
    "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda",
    "Saudi Arabia", "Senegal", "Serbia", "Singapore", "Slovakia", "Slovenia", "South Africa", "South Korea",
    "Spain", "Sri Lanka", "Sudan", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania",
    "Thailand", "Tunisia", "Turkey", "Turkmenistan", "Uganda", "Ukraine", "United Arab Emirates",
    "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Venezuela", "Vietnam", "Yemen", "Zambia",
    "Zimbabwe", "Other"
];

const languages = [
    "Arabic", "Bengali", "Bulgarian", "Burmese", "Cantonese", "Catalan", "Croatian", "Czech", "Danish",
    "Dutch", "English", "Estonian", "Finnish", "French", "German", "Greek", "Gujarati", "Hebrew",
    "Hindi", "Hungarian", "Icelandic", "Indonesian", "Italian", "Japanese", "Javanese", "Kannada",
    "Korean", "Lao", "Latvian", "Lithuanian", "Macedonian", "Malay", "Malayalam", "Mandarin",
    "Marathi", "Min Nan / Taiwanese", "Mongolian", "Nepali", "Norwegian", "Pashto", "Persian (Farsi)",
    "Polish", "Portuguese", "Punjabi", "Romanian", "Russian", "Serbian", "Sinhala", "Slovak", "Slovenian",
    "Spanish", "Swahili", "Swedish", "Tagalog (Filipino)", "Tamil", "Telugu", "Thai", "Turkish",
    "Ukrainian", "Urdu", "Uzbek", "Vietnamese", "Welsh", "Wu Chinese", "Xhosa", "Yiddish", "Yoruba",
    "Zulu", "Other"
];

const regionsByCountry = {
    "United States": ["Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", 
        "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", 
        "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi",
        "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York",
        "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island",
        "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington",
        "West Virginia", "Wisconsin", "Wyoming", "Other"],
    "China": ["Anhui", "Beijing", "Chongqing", "Fujian", "Gansu", "Guangdong", "Guangxi", "Guizhou",
        "Hainan", "Hebei", "Heilongjiang", "Henan", "Hong Kong", "Hubei", "Hunan", "Inner Mongolia",
        "Jiangsu", "Jiangxi", "Jilin", "Liaoning", "Macau", "Ningxia", "Qinghai", "Shaanxi", "Shandong",
        "Shanghai", "Shanxi", "Sichuan", "Tianjin", "Tibet", "Xinjiang", "Yunnan", "Zhejiang", "Other"],
    "Japan": ["Aichi", "Akita", "Aomori", "Chiba", "Ehime", "Fukui", "Fukuoka", "Fukushima", "Gifu",
        "Gunma", "Hiroshima", "Hokkaido", "Hyogo", "Ibaraki", "Ishikawa", "Iwate", "Kagawa", "Kagoshima",
        "Kanagawa", "Kochi", "Kumamoto", "Kyoto", "Mie", "Miyagi", "Miyazaki", "Nagano", "Nagasaki",
        "Nara", "Niigata", "Oita", "Okayama", "Okinawa", "Osaka", "Saga", "Saitama", "Shiga", "Shimane",
        "Shizuoka", "Tochigi", "Tokushima", "Tokyo", "Tottori", "Toyama", "Wakayama", "Yamagata",
        "Yamaguchi", "Yamanashi", "Other"],
    "South Korea": ["Busan", "Chungcheongbuk-do", "Chungcheongnam-do", "Daegu", "Daejeon", "Gangwon-do",
        "Gwangju", "Gyeonggi-do", "Gyeongsangbuk-do", "Gyeongsangnam-do", "Incheon", "Jeju", "Jeollabuk-do",
        "Jeollanam-do", "Sejong", "Seoul", "Ulsan", "Other"],
    "Taiwan": ["Taipei", "New Taipei", "Taoyuan", "Taichung", "Tainan", "Kaohsiung", "Keelung", "Hsinchu",
        "Chiayi", "Changhua", "Yunlin", "Pingtung", "Yilan", "Hualien", "Taitung", "Penghu", "Kinmen",
        "Lienchiang", "Other"],
    "United Kingdom": ["England", "Scotland", "Wales", "Northern Ireland", "Other"],
    "Canada": ["Alberta", "British Columbia", "Manitoba", "New Brunswick", "Newfoundland and Labrador",
        "Northwest Territories", "Nova Scotia", "Nunavut", "Ontario", "Prince Edward Island", "Quebec",
        "Saskatchewan", "Yukon", "Other"],
    "Australia": ["Australian Capital Territory", "New South Wales", "Northern Territory", "Queensland",
        "South Australia", "Tasmania", "Victoria", "Western Australia", "Other"],
    "India": ["Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat",
        "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra",
        "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim",
        "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal", "Other"],
    "Germany": ["Baden-Württemberg", "Bavaria", "Berlin", "Brandenburg", "Bremen", "Hamburg", "Hesse",
        "Lower Saxony", "Mecklenburg-Vorpommern", "North Rhine-Westphalia", "Rhineland-Palatinate",
        "Saarland", "Saxony", "Saxony-Anhalt", "Schleswig-Holstein", "Thuringia", "Other"],
    "France": ["Auvergne-Rhône-Alpes", "Bourgogne-Franche-Comté", "Brittany", "Centre-Val de Loire",
        "Corsica", "Grand Est", "Hauts-de-France", "Île-de-France", "Normandy", "Nouvelle-Aquitaine",
        "Occitanie", "Pays de la Loire", "Provence-Alpes-Côte d'Azur", "Other"]
};

/******************************************************************************
 * Test Stimuli Configuration
 ******************************************************************************/

const testSections = {
    tone_practice: [
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'tone', answer: 'Low'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'tone', answer: 'High'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'tone', answer: 'Low'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'tone', answer: 'High'}
    ],
    tone_main: [
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'tone'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'tone'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'tone'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'tone'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'tone'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'tone'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'tone'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'tone'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'tone'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'tone'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'tone'}
    ],
    coda_practice: [
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'coda', answer: 'ak'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'coda', answer: 'ap'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'coda', answer: 'at'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'coda', answer: 'ah'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'coda', answer: 'ak'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'coda', answer: 'ap'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'coda', answer: 'at'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'coda', answer: 'ah'}
    ],
    coda_main: [
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V20-UTC007-P-NAN001.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'coda'},
        {audio: 'V23-UTC008-P-NAN001.wav', type: 'coda'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'coda'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'coda'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V15-UTC005-P-NAN001.wav', type: 'coda'},
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'coda'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'coda'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN002.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'coda'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'coda'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'coda'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'coda'}
    ],
    combined_main: [
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'combined'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'combined'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN001.wav', type: 'combined'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V20-UTC007-P-NAN001.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'combined'},
        {audio: 'V23-UTC008-P-NAN001.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'combined'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'combined'},
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'combined'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'combined'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V11-UTC004-P-NAN002.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'combined'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V17-UTC006-P-NAN002.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'combined'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'combined'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'combined'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'combined'},
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'combined'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'combined'},
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'combined'}
    ]
};

/******************************************************************************
 * Utility Functions
 ******************************************************************************/

function getTimestamp() {
    const dt = new Date();
    const year = dt.getFullYear();
    const month = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    const hour = String(dt.getHours()).padStart(2, '0');
    const minute = String(dt.getMinutes()).padStart(2, '0');
    const second = String(dt.getSeconds()).padStart(2, '0');
    return `${year}${month}${day}_${hour}${minute}${second}`;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

function createAudioPlayer(audioFile) {
    return `
        <div class="audio-player">
            <button class="play-button" onclick="playAudio('${audioFile}')">
                <span class="play-icon">▶</span>
            </button>
            <p>Click to play audio</p>
            <audio id="audio-${audioFile.replace(/[^a-zA-Z0-9]/g, '')}" preload="auto">
                <source src="sounds/${audioFile}" type="audio/wav">
            </audio>
        </div>
    `;
}

function playAudio(audioFile) {
    const audioId = 'audio-' + audioFile.replace(/[^a-zA-Z0-9]/g, '');
    const audio = document.getElementById(audioId);
    if (audio) {
        audio.currentTime = 0;
        audio.play();
    }
}

function createPerceptionTrial(stimulus, trialNum, totalTrials, sectionName, isPractice) {
    let choices, prompt;
    
    if (stimulus.type === 'tone') {
        choices = ['Low', 'High'];
        prompt = '<p><strong>Is this Low or High tone?</strong></p>';
    } else if (stimulus.type === 'coda') {
        choices = ['ak', 'ap', 'at', 'ah'];
        prompt = '<p><strong>Which coda do you hear?</strong></p>';
    } else {
        choices = ['Low-ak', 'Low-ap', 'Low-at', 'Low-ah', 'High-ak', 'High-ap', 'High-at', 'High-ah'];
        prompt = '<p><strong>Which tone and coda combination do you hear?</strong></p>';
    }
    
    const trial = {
        type: 'html-button-response',
        stimulus: function() {
            const percentage = Math.round((trialNum / totalTrials) * 100);
            const header = `
                <div class="trial-header">
                    <div class="trial-number">Question ${trialNum} of ${totalTrials}</div>
                    <div class="progress-text">Progress: ${percentage}%</div>
                </div>
            `;
            return header + createAudioPlayer(stimulus.audio) + prompt;
        },
        choices: choices,
        data: {
            question_number: trialNum,
            section: sectionName,
            stimulus: stimulus.audio,
            task_type: stimulus.type,
            is_practice: isPractice
        },
        on_finish: function(data) {
            data.response = choices[data.button_pressed];
            data.response_number = data.button_pressed + 1;
        }
    };
    
    if (isPractice && stimulus.answer) {
        return [trial, {
            type: 'html-button-response',
            stimulus: function() {
                const lastTrial = jsPsych.data.get().last(1).values()[0];
                const correct = lastTrial.response === stimulus.answer;
                
                if (correct) {
                    return `
                        <div class="feedback-correct">✓ Correct!</div>
                        <div class="feedback-answer">You selected: ${lastTrial.response}</div>
                        <p>Click "Continue" for the next question.</p>
                    `;
                } else {
                    return `
                        <div class="feedback-incorrect">✗ Incorrect</div>
                        <div class="feedback-answer">You selected: ${lastTrial.response}</div>
                        <div class="feedback-answer">Correct answer: ${stimulus.answer}</div>
                        <p>Click "Continue" for the next question.</p>
                    `;
                }
            },
            choices: ['Continue']
        }];
    }
    
    return trial;
}

/******************************************************************************
 * Build Timeline
 ******************************************************************************/

var timeline = [];

// Welcome with requirements
timeline.push({
    type: 'instructions',
    pages: [`<h1>Welcome to the Perception Test</h1>
        <div class="instruction-text">
            <p>Thank you for participating in this study!</p>
            <p>This test will take approximately <strong>6-8 minutes</strong> to complete.</p>
            
            <div class="requirement-box">
                <strong>Requirements - Please ensure:</strong><br>
                ✓ You have <strong>no known hearing problems</strong><br>
                ✓ You are wearing <strong>headphones or earphones</strong><br>
                ✓ You are using a <strong>computer or tablet</strong> (larger screen preferred)<br>
                ✓ You are in a <strong>quiet environment</strong>
            </div>
            
            <p>If you meet all these requirements, click "Next" to continue to the background survey.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Next'
});

// Background Survey - Custom HTML form
timeline.push({
    type: 'survey-html-form',
    preamble: '<h1>Perception Test - Background Survey (Revised Version)</h1><p>Please answer all questions.</p>',
    html: `
        <div class="survey-question">
            <label for="q1">Q1. What is your age?</label>
            <small>Please select a number between 0 and 100</small>
            <input type="number" id="q1" name="Q1_Age" min="0" max="100" required>
        </div>
        
        <div class="survey-question">
            <label for="q2">Q2. What is your gender?</label>
            <select id="q2" name="Q2_Gender" required>
                <option value="">-- Select --</option>
                <option value="Male">A. Male</option>
                <option value="Female">B. Female</option>
                <option value="Prefer not to say">C. Prefer not to say</option>
            </select>
        </div>
        
        <div class="survey-question">
            <label for="q3_country">Q3. Where do you come from?</label>
            <small>Select country and region</small>
            <select id="q3_country" name="Q3_Country" required onchange="updateRegions()">
                <option value="">-- Select Country --</option>
                ${countries.map(c => `<option value="${c}">${c}</option>`).join('')}
            </select>
            <select id="q3_region" name="Q3_Region" required style="margin-top: 10px;">
                <option value="">-- Select Region --</option>
            </select>
        </div>
        
        <div class="survey-question">
            <label for="q4">Q4. Which language did you mainly use before the age of 12?</label>
            <small>Please select ONE option</small>
            <select id="q4" name="Q4_L1" required>
                <option value="">-- Select Language --</option>
                ${languages.map(lang => `<option value="${lang}">${lang}</option>`).join('')}
            </select>
        </div>
        
        <div class="survey-question">
            <label>Q5. Which other languages can you speak fluently?</label>
            <small>You may select multiple options. Click "Add Language" to add more.</small>
            <div id="language-container">
                <div class="language-item" id="lang-item-none">
                    <label><input type="checkbox" id="q5-none" name="Q5_None" value="None" onchange="toggleNone()"> None</label>
                </div>
            </div>
            <button type="button" class="add-language-btn" onclick="addLanguage()">+ Add Language</button>
        </div>
        
        <div class="survey-question">
            <label for="q6">Q6. How many years of formal musical training have you received?</label>
            <small>Please select a number between 0 and 50</small>
            <input type="number" id="q6" name="Q6_Music_Years" min="0" max="50" required>
        </div>
        
        <div class="survey-question">
            <label for="q7">Q7. Do you have absolute pitch?</label>
            <select id="q7" name="Q7_Absolute_Pitch" required>
                <option value="">-- Select --</option>
                <option value="YES">YES</option>
                <option value="NO">NO</option>
                <option value="Not Sure">Not Sure</option>
            </select>
        </div>
        
        <div class="survey-question">
            <label for="q8">Q8. Have you received any formal pronunciation training?</label>
            <select id="q8" name="Q8_Pronunciation_Training" required>
                <option value="">-- Select --</option>
                <option value="YES">YES</option>
                <option value="NO">NO</option>
            </select>
        </div>
        
        <script>
            var languageCount = 0;
            
            function updateRegions() {
                var country = document.getElementById('q3_country').value;
                var regionSelect = document.getElementById('q3_region');
                regionSelect.innerHTML = '<option value="">-- Select Region --</option>';
                
                var regions = ${JSON.stringify(regionsByCountry)}[country] || ['Other'];
                regions.forEach(function(region) {
                    var option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    regionSelect.appendChild(option);
                });
            }
            
            function addLanguage() {
                if (document.getElementById('q5-none').checked) {
                    alert('Please uncheck "None" before adding languages.');
                    return;
                }
                
                languageCount++;
                var container = document.getElementById('language-container');
                var div = document.createElement('div');
                div.className = 'language-item';
                div.id = 'lang-item-' + languageCount;
                div.innerHTML = \`
                    <label>Language \${languageCount}:</label>
                    <select name="Q5_Language_\${languageCount}" required>
                        <option value="">-- Select Language --</option>
                        ${languages.map(lang => `<option value="${lang}">${lang}</option>`).join('')}
                    </select>
                    <button type="button" class="remove-language-btn" onclick="removeLanguage(\${languageCount})">Remove</button>
                \`;
                container.appendChild(div);
            }
            
            function removeLanguage(id) {
                var item = document.getElementById('lang-item-' + id);
                if (item) {
                    item.remove();
                }
            }
            
            function toggleNone() {
                var noneChecked = document.getElementById('q5-none').checked;
                if (noneChecked) {
                    // Remove all added languages
                    var container = document.getElementById('language-container');
                    var items = container.querySelectorAll('.language-item:not(#lang-item-none)');
                    items.forEach(function(item) {
                        item.remove();
                    });
                    languageCount = 0;
                }
            }
        </script>
    `,
    button_label: 'Continue to Test',
    on_finish: function(data) {
        // Process language data
        var responses = data.response;
        var languages = [];
        
        if (responses.Q5_None === 'None') {
            languages.push('None');
        } else {
            for (var key in responses) {
                if (key.startsWith('Q5_Language_')) {
                    languages.push(responses[key]);
                }
            }
        }
        
        data.Q5_Languages = languages.join('; ');
    }
});

// Calculate trial counters
let trialNum = 1;
let totalTrials = 4 + 20 + 8 + 40 + 40;

// Test sections...
timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 1: Tone Practice (4 trials)</h1>
        <div class="instruction-text">
            <p>You will practice identifying <strong>Low</strong> vs <strong>High</strong> tones.</p>
            <p>After each answer, you will see if you were correct.</p>
            <p>Click the green button to play audio. You can replay as many times as you want.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.tone_practice.forEach(stim => {
    const trials = createPerceptionTrial(stim, trialNum++, totalTrials, 'Tone_Practice', true);
    if (Array.isArray(trials)) {
        trials.forEach(t => timeline.push(t));
    } else {
        timeline.push(trials);
    }
});

timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 2: Tone Test (20 trials)</h1>
        <div class="instruction-text">
            <p>Now the actual test begins.</p>
            <p>Continue identifying Low vs High tones.</p>
            <p>You will NOT see correct answers anymore.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.tone_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Tone_Main', false));
});

timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 3: Coda Practice (8 trials)</h1>
        <div class="instruction-text">
            <p>Now you will practice identifying word-final consonants (codas).</p>
            <p>Listen for: <strong>ak, ap, at, or ah</strong></p>
            <p>After each answer, you will see if you were correct.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.coda_practice.forEach(stim => {
    const trials = createPerceptionTrial(stim, trialNum++, totalTrials, 'Coda_Practice', true);
    if (Array.isArray(trials)) {
        trials.forEach(t => timeline.push(t));
    } else {
        timeline.push(trials);
    }
});

timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 4: Coda Test (40 trials)</h1>
        <div class="instruction-text">
            <p>Continue identifying codas: ak, ap, at, or ah</p>
            <p>You will NOT see correct answers anymore.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.coda_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Coda_Main', false));
});

timeline.push({
    type: 'instructions',
    pages: [`<h1>Part 5: Combined Test (40 trials)</h1>
        <div class="instruction-text">
            <p>Now you will identify BOTH tone and coda together.</p>
            <p>Options: Low-ak, Low-ap, Low-at, Low-ah, High-ak, High-ap, High-at, High-ah</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.combined_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialNum++, totalTrials, 'Combined_Main', false));
});

timeline.push({
    type: 'instructions',
    pages: [`<h1>Test Complete!</h1>
        <div class="instruction-text">
            <p>Thank you for your participation!</p>
            <p>Your data is being saved...</p>
            <p>Click "Finish" to complete.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Finish'
});

/******************************************************************************
 * Run Experiment
 ******************************************************************************/

jsPsych.init({
    timeline: timeline,
    show_progress_bar: true,
    on_finish: function() {
        var allData = jsPsych.data.get();
        
        // Get survey data
        var surveyData = allData.filter({trial_type: 'survey-html-form'});
        var surveyResponses = {};
        if (surveyData.count() > 0) {
            surveyResponses = surveyData.values()[0].response;
            // Add processed languages
            surveyResponses.Q5_Languages = surveyData.values()[0].Q5_Languages;
        }
        
        // Get perception trials
        var perceptionData = allData.filter({trial_type: 'html-button-response'}).filter(function(trial) {
            return trial.question_number !== undefined && !trial.choices.includes('Continue');
        });
        
        // Build CSV with 1-based indexing
        var csvContent = "Question_Number,Response,Response_Number\n";
        
        // Add survey responses
        csvContent += `Q1_Age,"${surveyResponses.Q1_Age}",${surveyResponses.Q1_Age}\n`;
        
        var genderOptions = ['Male', 'Female', 'Prefer not to say'];
        var genderNum = genderOptions.indexOf(surveyResponses.Q2_Gender) + 1;
        csvContent += `Q2_Gender,"${surveyResponses.Q2_Gender}",${genderNum}\n`;
        
        csvContent += `Q3_Country,"${surveyResponses.Q3_Country}",N/A\n`;
        csvContent += `Q3_Region,"${surveyResponses.Q3_Region}",N/A\n`;
        
        var langIndex = languages.indexOf(surveyResponses.Q4_L1) + 1;
        csvContent += `Q4_L1,"${surveyResponses.Q4_L1}",${langIndex}\n`;
        
        csvContent += `Q5_Languages,"${surveyResponses.Q5_Languages}",N/A\n`;
        csvContent += `Q6_Music_Years,"${surveyResponses.Q6_Music_Years}",${surveyResponses.Q6_Music_Years}\n`;
        
        var pitchOptions = ['YES', 'NO', 'Not Sure'];
        var pitchNum = pitchOptions.indexOf(surveyResponses.Q7_Absolute_Pitch) + 1;
        csvContent += `Q7_Absolute_Pitch,"${surveyResponses.Q7_Absolute_Pitch}",${pitchNum}\n`;
        
        var trainOptions = ['YES', 'NO'];
        var trainNum = trainOptions.indexOf(surveyResponses.Q8_Pronunciation_Training) + 1;
        csvContent += `Q8_Pronunciation_Training,"${surveyResponses.Q8_Pronunciation_Training}",${trainNum}\n`;
        
        // Add perception trials
        perceptionData.values().forEach(function(trial) {
            var qNum = parseInt(trial.question_number) + 8; // Offset by 8 background questions
            csvContent += `${qNum},${trial.response},${trial.response_number}\n`;
        });
        
        // Download CSV
        var filename = 'kpth_perception_' + getTimestamp() + '.csv';
        downloadCSV(csvContent, filename);
        
        // Upload to Google Sheets
        uploadToGoogleSheets(csvContent);
        
        document.querySelector('#jspsych-content').innerHTML = 
            '<h1>Data saved! Thank you for participating.</h1><p>You may close this page.</p>';
    }
});

function uploadToGoogleSheets(csvData) {
    fetch(GOOGLE_SHEETS_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'text/plain',
        },
        body: csvData
    }).then(function() {
        console.log('Data uploaded to Google Sheets');
    }).catch(function(error) {
        console.log('Could not upload to Google Sheets:', error);
    });
}

</script>
</html>

<!--
===============================================================================
GOOGLE SHEETS SETUP: Same as before - see previous instructions
===============================================================================
-->
