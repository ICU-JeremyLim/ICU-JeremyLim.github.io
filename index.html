<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kpth Tone Perception Test</title>
    
    <!-- Load jsPsych -->
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/jspsych-instructions.js"></script>
    <script src="jspsych/jspsych-html-button-response.js"></script>
    <script src="jspsych/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych/jspsych-survey-multi-select.js"></script>
    <link href="css/jspsych.css" rel="stylesheet" type="text/css">
    
    <style>
        body { background-color: #f5f5f5; }
        .jspsych-btn { margin: 10px; padding: 15px 30px; font-size: 18px; }
        .jspsych-content-wrapper { width: 85%; max-width: 900px; }
        .jspsych-content { padding: 30px; }
        h1 { color: #333; margin-bottom: 20px; }
        .instruction-text { text-align: left; line-height: 1.6; font-size: 16px; }
        
        .audio-player { text-align: center; margin: 30px 0; }
        .play-button {
            background-color: #4CAF50; border: none; color: white; padding: 20px;
            text-align: center; display: inline-block; font-size: 16px; cursor: pointer;
            border-radius: 50%; width: 80px; height: 80px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s;
        }
        .play-button:hover { background-color: #45a049; box-shadow: 0 6px 12px rgba(0,0,0,0.3); transform: scale(1.05); }
        .play-button:active { transform: scale(0.95); }
        .play-icon { font-size: 32px; }
        
        .jspsych-survey-multi-choice-question,
        .jspsych-survey-multi-select-question { margin: 25px 0; text-align: left; }
        .jspsych-survey-multi-choice-text,
        .jspsych-survey-multi-select-text { font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        .jspsych-survey-multi-choice-option,
        .jspsych-survey-multi-select-option { margin: 8px 0; font-size: 15px; }
    </style>
</head>

<body>
    <div id="jspsych-target"></div>
</body>

<script>

/******************************************************************************
 * Test Stimuli Configuration
 ******************************************************************************/

// All test trials organized by section
const testSections = {
    tone_practice: [
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'tone'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'tone'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'tone'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'tone'}
    ],
    tone_main: [
        // Speaker NAN001
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'tone'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'tone'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'tone'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'tone'},
        // Speaker NAN002
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'tone'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'tone'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'tone'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'tone'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'tone'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'tone'}
    ],
    tone_repeat: [
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'tone'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'tone'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'tone'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'tone'}
    ],
    coda_practice: [
        // Speaker NAN001
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'coda'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'coda'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'coda'},
        // Speaker NAN002
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'coda'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'coda'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'coda'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'coda'}
    ],
    coda_main: [
        // Speaker NAN001
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V20-UTC007-P-NAN001.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'coda'},
        {audio: 'V23-UTC008-P-NAN001.wav', type: 'coda'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'coda'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'coda'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V15-UTC005-P-NAN001.wav', type: 'coda'},
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'coda'},
        // Speaker NAN002
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'coda'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'coda'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN002.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'coda'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'coda'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'coda'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'coda'}
    ],
    coda_repeat: [
        // NAN001
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'coda'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'coda'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'coda'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'coda'},
        // NAN002
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'coda'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'coda'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'coda'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'coda'}
    ],
    combined_main: [
        // NAN001
        {audio: 'V02-UTC001-P-NAN001.wav', type: 'combined'},
        {audio: 'V05-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V08-UTC003-P-NAN001.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN001.wav', type: 'combined'},
        {audio: 'V11-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V14-UTC005-P-NAN001.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN001.wav', type: 'combined'},
        {audio: 'V17-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V20-UTC007-P-NAN001.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN001.wav', type: 'combined'},
        {audio: 'V23-UTC008-P-NAN001.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'combined'},
        {audio: 'V03-UTC001-P-NAN001.wav', type: 'combined'},
        // NAN002
        {audio: 'V03-UTC001-P-NAN002.wav', type: 'combined'},
        {audio: 'V06-UTC002-P-NAN002.wav', type: 'combined'},
        {audio: 'V08-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V11-UTC004-P-NAN002.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN002.wav', type: 'combined'},
        {audio: 'V14-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V17-UTC006-P-NAN002.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN002.wav', type: 'combined'},
        {audio: 'V20-UTC007-P-NAN002.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'combined'},
        {audio: 'V23-UTC008-P-NAN002.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN002.wav', type: 'combined'},
        {audio: 'V02-UTC001-P-NAN002.wav', type: 'combined'},
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'combined'}
    ],
    combined_repeat: [
        // NAN001
        {audio: 'V06-UTC002-P-NAN001.wav', type: 'combined'},
        {audio: 'V12-UTC004-P-NAN001.wav', type: 'combined'},
        {audio: 'V18-UTC006-P-NAN001.wav', type: 'combined'},
        {audio: 'V24-UTC008-P-NAN001.wav', type: 'combined'},
        // NAN002
        {audio: 'V05-UTC002-P-NAN002.wav', type: 'combined'},
        {audio: 'V09-UTC003-P-NAN002.wav', type: 'combined'},
        {audio: 'V15-UTC005-P-NAN002.wav', type: 'combined'},
        {audio: 'V21-UTC007-P-NAN002.wav', type: 'combined'}
    ]
};

/******************************************************************************
 * Utility Functions
 ******************************************************************************/

function getTimestamp() {
    const dt = new Date();
    const year = dt.getFullYear();
    const month = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    const hour = String(dt.getHours()).padStart(2, '0');
    const minute = String(dt.getMinutes()).padStart(2, '0');
    const second = String(dt.getSeconds()).padStart(2, '0');
    return `${year}${month}${day}_${hour}${minute}${second}`;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

function createAudioPlayer(audioFile) {
    return `
        <div class="audio-player">
            <button class="play-button" onclick="playAudio('${audioFile}')">
                <span class="play-icon">▶</span>
            </button>
            <p>Click to play audio</p>
            <audio id="audio-${audioFile.replace(/[^a-zA-Z0-9]/g, '')}" preload="auto">
                <source src="sounds/${audioFile}" type="audio/wav">
            </audio>
        </div>
    `;
}

function playAudio(audioFile) {
    const audioId = 'audio-' + audioFile.replace(/[^a-zA-Z0-9]/g, '');
    const audio = document.getElementById(audioId);
    if (audio) {
        audio.currentTime = 0;
        audio.play();
    }
}

function createPerceptionTrial(stimulus, trialNum, sectionName) {
    let choices, prompt;
    
    if (stimulus.type === 'tone') {
        choices = ['Low', 'High'];
        prompt = '<p><strong>Is this Low or High tone?</strong></p>';
    } else if (stimulus.type === 'coda') {
        choices = ['ak', 'ap', 'at', 'ah'];
        prompt = '<p><strong>Which coda do you hear?</strong></p>';
    } else { // combined
        choices = ['Low-ak', 'Low-ap', 'Low-at', 'Low-ah', 'High-ak', 'High-ap', 'High-at', 'High-ah'];
        prompt = '<p><strong>Which tone and coda combination do you hear?</strong></p>';
    }
    
    return {
        type: 'html-button-response',
        stimulus: function() {
            return createAudioPlayer(stimulus.audio) + prompt;
        },
        choices: choices,
        data: {
            question_number: trialNum,
            section: sectionName,
            stimulus: stimulus.audio,
            task_type: stimulus.type
        },
        on_finish: function(data) {
            data.response = choices[data.button_pressed];
            data.response_number = data.button_pressed;
        }
    };
}

/******************************************************************************
 * Build Timeline
 ******************************************************************************/

var timeline = [];

// Welcome
timeline.push({
    type: 'instructions',
    pages: [`<h1>Welcome to the Perception Test</h1>
        <div class="instruction-text">
            <p>Thank you for participating!</p>
            <p>This test will take approximately <strong>20-25 minutes</strong> to complete.</p>
            <p>Please ensure you are in a quiet environment and wearing headphones.</p>
            <p>Click "Next" to continue.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Next'
});

// Demographics - Single choice
timeline.push({
    type: 'survey-multi-choice',
    questions: [
        {prompt: '<strong>Q1. Age</strong>', options: ['18-19', '20-22', '23-25', '26-30', '31-40', '41-49', '50-59', '60-69', '70-79', '80+'], required: true, name: 'Q1_Age'},
        {prompt: '<strong>Q2. Hearing Status</strong>', options: ['No known hearing problems', 'Mild hearing problem / Tinnitus', 'Confirmed hearing diagnosis', 'Not sure'], required: true, name: 'Q2_Hearing'},
        {prompt: '<strong>Q3. First Language (L1)</strong>', options: ['Japanese', 'English', 'Mandarin', 'Min Nan / Taiwanese', 'Cantonese', 'Korean', 'Thai', 'Other (Tonal)', 'Other (Non-tonal)'], required: true, name: 'Q3_L1'},
        {prompt: '<strong>Q6. Have you received music training?</strong>', options: ['No', 'Yes (Non-systematic / Interest-based)', 'Yes (Systematic training)'], required: true, name: 'Q6_Music_Training'},
        {prompt: '<strong>Q7. Years of Music Training</strong>', options: ['0', '1-2 years', '3-4 years', '5-7 years', '8-10 years', '10+ years'], required: true, name: 'Q7_Music_Years'},
        {prompt: '<strong>Q8. Do you have absolute pitch?</strong>', options: ['Yes (Professionally tested and confirmed)', 'Possibly (Self-judgment)', 'No', 'Not sure'], required: true, name: 'Q8_Absolute_Pitch'},
        {prompt: '<strong>Q9. Testing Device</strong>', options: ['Computer + Headphones', 'Computer + Speakers', 'Mobile + Headphones', 'Mobile + Speakers'], required: true, name: 'Q9_Device'},
        {prompt: '<strong>Q10. Current Environment Quietness</strong>', options: ['Very quiet', 'Normal', 'Somewhat noisy'], required: true, name: 'Q10_Environment'},
        {prompt: '<strong>Q11. Have you studied linguistics/phonetics/pronunciation?</strong>', options: ['No', 'Took one course/short training (< 1 semester)', 'Systematic study (≥ 1 semester)', 'Not sure'], required: true, name: 'Q11_Phonetics'},
        {prompt: '<strong>Q12. Can you read romanization/phonetic symbols to judge pronunciation?</strong>', options: ['Not at all', 'A little (very general)', 'Quite well (commonly used)', 'Not sure'], required: true, name: 'Q12_Romanization'},
        {prompt: '<strong>Q13. Does your native/main language have common word-final consonants?</strong><br><small>(Common meaning regularly having -p/-t/-k or similar coda)</small>', options: ['Yes (Codas like -p/-t/-k are common)', 'Somewhat', 'Very few/almost none', 'Not sure'], required: true, name: 'Q13_Coda'}
    ],
    preamble: '<h1>Participant Information</h1>',
    button_label: 'Continue'
});

// Demographics - Multiple choice
timeline.push({
    type: 'survey-multi-select',
    questions: [
        {prompt: '<strong>Q4. Second Language(s) / Other Familiar Languages</strong><br><small>(Multiple selections allowed)</small>', options: ['Japanese', 'English', 'Mandarin', 'Min Nan / Taiwanese', 'Cantonese', 'Korean', 'Thai', 'French', 'German', 'Spanish', 'Italian', 'Russian', 'Other (Tonal)', 'Other (Non-tonal)'], required: false, name: 'Q4_L2'},
        {prompt: '<strong>Q5. Have you had long-term exposure to tonal language environments?</strong><br><small>(Multiple selections allowed)</small>', options: ['Used at home or while growing up', 'Learned in school/classes', 'Lived in a tonal language region', 'Used regularly with friends/colleagues', 'Almost none'], required: false, name: 'Q5_Tonal_Exposure'}
    ],
    preamble: '<h1>Participant Information (Continued)</h1>',
    button_label: 'Continue'
});

// Section 1: Tone Practice
timeline.push({
    type: 'instructions',
    pages: [`<h1>Section 1: Tone Practice (4 trials)</h1>
        <div class="instruction-text">
            <p>In this section, you will practice identifying <strong>Low</strong> vs <strong>High</strong> tones.</p>
            <p>Click the green button to play each audio. You can replay as many times as you want.</p>
            <p>Select whether you hear a Low or High tone.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

let trialCounter = 1;
testSections.tone_practice.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialCounter++, 'Tone_Practice'));
});

// Section 2: Tone Main
timeline.push({
    type: 'instructions',
    pages: [`<h1>Section 2: Tone Main Test (16 trials)</h1>
        <div class="instruction-text">
            <p>This is the main tone perception test.</p>
            <p>Continue identifying Low vs High tones.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.tone_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialCounter++, 'Tone_Main'));
});

// Section 3: Tone Repeat
timeline.push({
    type: 'instructions',
    pages: [`<h1>Section 3: Tone Repeat (4 trials)</h1>
        <div class="instruction-text">
            <p>These are repeat trials for tone perception.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.tone_repeat.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialCounter++, 'Tone_Repeat'));
});

// Section 4: Coda Practice
timeline.push({
    type: 'instructions',
    pages: [`<h1>Section 4: Coda Practice (8 trials)</h1>
        <div class="instruction-text">
            <p>Now you will practice identifying word-final consonants (codas).</p>
            <p>Listen for: <strong>ak, ap, at, or ah</strong></p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.coda_practice.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialCounter++, 'Coda_Practice'));
});

// Section 5: Coda Main
timeline.push({
    type: 'instructions',
    pages: [`<h1>Section 5: Coda Main Test (32 trials)</h1>
        <div class="instruction-text">
            <p>This is the main coda perception test.</p>
            <p>Continue identifying: ak, ap, at, or ah</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.coda_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialCounter++, 'Coda_Main'));
});

// Section 6: Coda Repeat
timeline.push({
    type: 'instructions',
    pages: [`<h1>Section 6: Coda Repeat (8 trials)</h1>
        <div class="instruction-text">
            <p>These are repeat trials for coda perception.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.coda_repeat.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialCounter++, 'Coda_Repeat'));
});

// Section 7: Combined Main
timeline.push({
    type: 'instructions',
    pages: [`<h1>Section 7: Combined Test (32 trials)</h1>
        <div class="instruction-text">
            <p>Now you will identify BOTH tone and coda together.</p>
            <p>Options: Low-ak, Low-ap, Low-at, Low-ah, High-ak, High-ap, High-at, High-ah</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.combined_main.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialCounter++, 'Combined_Main'));
});

// Section 8: Combined Repeat
timeline.push({
    type: 'instructions',
    pages: [`<h1>Section 8: Combined Repeat (8 trials)</h1>
        <div class="instruction-text">
            <p>Final section! These are repeat trials for the combined test.</p>
            <p>Click "Start" when ready.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Start'
});

testSections.combined_repeat.forEach(stim => {
    timeline.push(createPerceptionTrial(stim, trialCounter++, 'Combined_Repeat'));
});

// Debrief
timeline.push({
    type: 'instructions',
    pages: [`<h1>Test Complete!</h1>
        <div class="instruction-text">
            <p>Thank you for your participation!</p>
            <p>Click "Download Data" to save your results.</p>
        </div>`],
    show_clickable_nav: true,
    button_label_next: 'Download Data'
});

/******************************************************************************
 * Run Experiment
 ******************************************************************************/

const questionOptions = {
    'Q1_Age': ['18-19', '20-22', '23-25', '26-30', '31-40', '41-49', '50-59', '60-69', '70-79', '80+'],
    'Q2_Hearing': ['No known hearing problems', 'Mild hearing problem / Tinnitus', 'Confirmed hearing diagnosis', 'Not sure'],
    'Q3_L1': ['Japanese', 'English', 'Mandarin', 'Min Nan / Taiwanese', 'Cantonese', 'Korean', 'Thai', 'Other (Tonal)', 'Other (Non-tonal)'],
    'Q4_L2': ['Japanese', 'English', 'Mandarin', 'Min Nan / Taiwanese', 'Cantonese', 'Korean', 'Thai', 'French', 'German', 'Spanish', 'Italian', 'Russian', 'Other (Tonal)', 'Other (Non-tonal)'],
    'Q5_Tonal_Exposure': ['Used at home or while growing up', 'Learned in school/classes', 'Lived in a tonal language region', 'Used regularly with friends/colleagues', 'Almost none'],
    'Q6_Music_Training': ['No', 'Yes (Non-systematic / Interest-based)', 'Yes (Systematic training)'],
    'Q7_Music_Years': ['0', '1-2 years', '3-4 years', '5-7 years', '8-10 years', '10+ years'],
    'Q8_Absolute_Pitch': ['Yes (Professionally tested and confirmed)', 'Possibly (Self-judgment)', 'No', 'Not sure'],
    'Q9_Device': ['Computer + Headphones', 'Computer + Speakers', 'Mobile + Headphones', 'Mobile + Speakers'],
    'Q10_Environment': ['Very quiet', 'Normal', 'Somewhat noisy'],
    'Q11_Phonetics': ['No', 'Took one course/short training (< 1 semester)', 'Systematic study (≥ 1 semester)', 'Not sure'],
    'Q12_Romanization': ['Not at all', 'A little (very general)', 'Quite well (commonly used)', 'Not sure'],
    'Q13_Coda': ['Yes (Codas like -p/-t/-k are common)', 'Somewhat', 'Very few/almost none', 'Not sure']
};

jsPsych.init({
    timeline: timeline,
    show_progress_bar: true,
    on_finish: function() {
        var allData = jsPsych.data.get();
        
        // Get demographics
        var demoSingle = allData.filter({trial_type: 'survey-multi-choice'});
        var demoMultiple = allData.filter({trial_type: 'survey-multi-select'});
        
        var demoResponses = {};
        if (demoSingle.count() > 0) Object.assign(demoResponses, demoSingle.values()[0].responses);
        if (demoMultiple.count() > 0) Object.assign(demoResponses, demoMultiple.values()[0].responses);
        
        // Get perception trials
        var perceptionData = allData.filter({trial_type: 'html-button-response'}).filter(function(trial) {
            return trial.question_number !== undefined;
        });
        
        // Build CSV
        var csvContent = "Question_Number,Response,Response_Number\n";
        
        // Add demographics (Q1-Q13)
        ['Q1_Age', 'Q2_Hearing', 'Q3_L1', 'Q4_L2', 'Q5_Tonal_Exposure', 'Q6_Music_Training', 'Q7_Music_Years', 'Q8_Absolute_Pitch', 'Q9_Device', 'Q10_Environment', 'Q11_Phonetics', 'Q12_Romanization', 'Q13_Coda'].forEach(function(qKey) {
            if (demoResponses[qKey]) {
                var response = demoResponses[qKey];
                var responseNum = '';
                
                if (qKey === 'Q4_L2' || qKey === 'Q5_Tonal_Exposure') {
                    try {
                        var selections = JSON.parse(response);
                        var selectedIndices = [];
                        var selectedTexts = [];
                        for (var idx in selections) {
                            if (selections[idx] === true) {
                                selectedIndices.push(idx);
                                selectedTexts.push(questionOptions[qKey][parseInt(idx)]);
                            }
                        }
                        responseNum = selectedIndices.join(';');
                        response = selectedTexts.join('; ');
                    } catch(e) { responseNum = 'error'; }
                } else {
                    responseNum = questionOptions[qKey].indexOf(response);
                }
                
                csvContent += `${qKey},"${response}",${responseNum}\n`;
            }
        });
        
        // Add perception trials (starting from question 14)
        perceptionData.values().forEach(function(trial) {
            var qNum = parseInt(trial.question_number) + 13; // Offset by 13 background questions
            csvContent += `${qNum},${trial.response},${trial.response_number}\n`;
        });
        
        var filename = 'kpth_perception_' + getTimestamp() + '.csv';
        downloadCSV(csvContent, filename);
        
        document.querySelector('#jspsych-content').innerHTML = 
            '<h1>Data saved! You may close this page.</h1>';
    }
});

</script>
</html>
