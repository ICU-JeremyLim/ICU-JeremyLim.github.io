<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kpth Tone Perception Test</title>
    
    <!-- Load jsPsych -->
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/jspsych-instructions.js"></script>
    <script src="jspsych/jspsych-html-button-response.js"></script>
    <script src="jspsych/jspsych-survey-multi-choice.js"></script>
    <link href="css/jspsych.css" rel="stylesheet" type="text/css">
    
    <style>
        body {
            background-color: #f5f5f5;
        }
        .jspsych-btn {
            margin: 10px;
            padding: 15px 30px;
            font-size: 18px;
        }
        .jspsych-content-wrapper {
            width: 85%;
            max-width: 900px;
        }
        .jspsych-content {
            padding: 30px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .instruction-text {
            text-align: left;
            line-height: 1.6;
            font-size: 16px;
        }
        
        /* 音频播放按钮 */
        .audio-player {
            text-align: center;
            margin: 30px 0;
        }
        .play-button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 20px;
            text-align: center;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        .play-button:hover {
            background-color: #45a049;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            transform: scale(1.05);
        }
        .play-button:active {
            transform: scale(0.95);
        }
        .play-icon {
            font-size: 32px;
        }
        
        /* 问卷样式 */
        .jspsych-survey-multi-choice-question {
            margin: 25px 0;
            text-align: left;
        }
        .jspsych-survey-multi-choice-text {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .jspsych-survey-multi-choice-option {
            margin: 8px 0;
            font-size: 15px;
        }
    </style>
</head>

<body>
    <div id="jspsych-target"></div>
</body>

<script>

/******************************************************************************
 * 五语言文本
 ******************************************************************************/

const translations = {
    en: {
        // 语言选择
        lang_select_title: "Language Selection",
        
        // 欢迎页
        welcome_title: "Welcome to the Perception Test",
        welcome_text: `
            <p>Thank you for participating in this experiment!</p>
            <p>This test will take approximately <strong>5 minutes</strong> to complete.</p>
            <p>Please ensure you are in a quiet environment and wearing headphones.</p>
            <p>Click "Next" to continue.</p>
        `,
        
        // 问卷
        demographics_title: "Participant Information",
        q_age: "Age",
        q_age_opts: ["18-19", "20-22", "23-25", "26-30", "31-40", "41-49", "50-59", "60-69", "70-79", "80+"],
        q_hearing: "Hearing Status",
        q_hearing_opts: ["No known hearing problems", "Mild hearing problem / Tinnitus", "Confirmed hearing diagnosis", "Not sure"],
        q_l1: "First Language (L1)",
        q_l1_opts: ["Japanese", "English", "Mandarin", "Min Nan / Taiwanese", "Cantonese", "Korean", "Thai", "Other (Tonal)", "Other (Non-tonal)"],
        q_l2: "Second Language(s) / Other Familiar Languages (Multiple selections allowed)",
        q_l2_note: "(Select only languages you can understand or use in daily life)",
        q_l2_opts: ["Japanese", "English", "Mandarin", "Min Nan / Taiwanese", "Cantonese", "Korean", "Thai", "French", "German", "Spanish", "Italian", "Russian", "Other (Tonal)", "Other (Non-tonal)"],
        q_tonal_exposure: "Have you had long-term exposure to tonal language environments? (Multiple selections allowed)",
        q_tonal_exposure_opts: ["Used at home or while growing up", "Learned in school/classes", "Lived in a tonal language region", "Used regularly with friends/colleagues", "Almost none"],
        q_music_training: "Have you received music training?",
        q_music_training_opts: ["No", "Yes (Non-systematic / Interest-based)", "Yes (Systematic training)"],
        q_music_years: "Years of Music Training",
        q_music_years_opts: ["0", "1-2 years", "3-4 years", "5-7 years", "8-10 years", "10+ years"],
        q_absolute_pitch: "Do you have absolute pitch?",
        q_absolute_pitch_opts: ["Yes (Professionally tested and confirmed)", "Possibly (Self-judgment)", "No", "Not sure"],
        q_device: "Testing Device",
        q_device_opts: ["Computer + Headphones", "Computer + Speakers", "Mobile + Headphones", "Mobile + Speakers"],
        q_environment: "Current Environment Quietness",
        q_environment_opts: ["Very quiet", "Normal", "Somewhat noisy"],
        q_phonetics: "Have you studied linguistics/phonetics/pronunciation?",
        q_phonetics_opts: ["No", "Took one course/short training (< 1 semester)", "Systematic study (≥ 1 semester)", "Not sure"],
        q_romanization: "Can you read romanization/phonetic symbols to judge pronunciation?",
        q_romanization_opts: ["Not at all", "A little (very general)", "Quite well (commonly used)", "Not sure"],
        q_coda: "Does your native/main language have common word-final consonants?",
        q_coda_note: "(Common meaning regularly having -p/-t/-k or similar coda)",
        q_coda_opts: ["Yes (Codas like -p/-t/-k are common)", "Somewhat", "Very few/almost none", "Not sure"],
        
        // 实验说明
        instructions_tone_title: "Question 1: Tone Judgment",
        instructions_tone_text: `
            <p>You will hear an audio clip.</p>
            <p>Please listen carefully and judge whether it is a <strong>Low</strong> or <strong>High</strong> tone.</p>
            <p><strong>Click the green button to play the audio.</strong> You can play it multiple times.</p>
            <p>Click "Start" to begin.</p>
        `,
        instructions_kpth_title: "Question 2: Coda Judgment",
        instructions_kpth_text: `
            <p>You will hear another audio clip.</p>
            <p>Please listen carefully and select the coda you hear:</p>
            <ul>
                <li><strong>ak</strong></li>
                <li><strong>ap</strong></li>
                <li><strong>at</strong></li>
                <li><strong>ah</strong></li>
            </ul>
            <p><strong>Click the green button to play the audio.</strong> You can play it multiple times.</p>
            <p>Click "Start" to begin.</p>
        `,
        debrief_title: "Test Complete!",
        debrief_text: `
            <p>Thank you for your participation!</p>
            <p>Click "Download Data" to save your test results.</p>
        `,
        
        // 按钮和提示
        play_audio: "Click to play audio",
        prompt_tone: "Please select the tone you heard:",
        prompt_kpth: "Please select the coda you heard:",
        button_next: "Next",
        button_start: "Start",
        button_download: "Download Data",
        button_submit: "Submit",
        completion_message: "Data saved! You may close this page."
    },
    
    ja: {
        lang_select_title: "言語選択",
        welcome_title: "知覚テストへようこそ",
        welcome_text: `
            <p>本実験にご参加いただきありがとうございます！</p>
            <p>このテストは約<strong>5分</strong>で完了します。</p>
            <p>静かな環境でヘッドフォンを装着してください。</p>
            <p>「次へ」をクリックして続けてください。</p>
        `,
        demographics_title: "参加者情報",
        q_age: "年齢",
        q_age_opts: ["18-19", "20-22", "23-25", "26-30", "31-40", "41-49", "50-59", "60-69", "70-79", "80+"],
        q_hearing: "聴力状況",
        q_hearing_opts: ["既知の聴力問題なし", "軽度の聴力問題/耳鳴り", "確認された聴力診断あり", "不明"],
        q_l1: "第一言語（L1）",
        q_l1_opts: ["日本語", "英語", "普通話（Mandarin）", "閩南語/台湾語", "広東語", "韓国語", "タイ語", "その他（声調言語）", "その他（非声調言語）"],
        q_l2: "第二言語/その他熟練している言語（複数選択可）",
        q_l2_note: "（日常生活で理解または使用できる言語のみ選択してください）",
        q_l2_opts: ["日本語", "英語", "普通話（Mandarin）", "閩南語/台湾語", "広東語", "韓国語", "タイ語", "フランス語", "ドイツ語", "スペイン語", "イタリア語", "ロシア語", "その他（声調言語）", "その他（非声調言語）"],
        q_tonal_exposure: "声調言語環境に長期接触したことがありますか？（複数選択可）",
        q_tonal_exposure_opts: ["家庭または成長中に使用", "学校/授業で学習", "声調言語地域に居住", "友人/同僚と頻繁に使用", "ほぼなし"],
        q_music_training: "音楽訓練を受けたことがありますか？",
        q_music_training_opts: ["いいえ", "はい（非系統的/興味）", "はい（系統的訓練）"],
        q_music_years: "音楽訓練年数",
        q_music_years_opts: ["0", "1-2年", "3-4年", "5-7年", "8-10年", "10年以上"],
        q_absolute_pitch: "絶対音感を持っていますか？",
        q_absolute_pitch_opts: ["はい（専門的テスト確認済）", "おそらく（自己判断）", "いいえ", "不明"],
        q_device: "使用テスト機器",
        q_device_opts: ["パソコン＋ヘッドフォン", "パソコン＋スピーカー", "スマホ＋ヘッドフォン", "スマホ＋スピーカー"],
        q_environment: "現在の環境の静けさ",
        q_environment_opts: ["非常に静か", "普通", "やや騒がしい"],
        q_phonetics: "言語学/音声学/発音訓練を学習したことがありますか？",
        q_phonetics_opts: ["いいえ", "1コース/短期訓練（< 1学期）", "系統的学習（≥ 1学期）", "不明"],
        q_romanization: "ローマ字/音標来判断発音ができますか？",
        q_romanization_opts: ["全くできない", "少しできる（非常に一般的）", "かなりできる（常用）", "不明"],
        q_coda: "母語/主要言語で語尾塞音が一般的ですか？",
        q_coda_note: "（一般的とは-p/-t/-kまたは類似した語尾が頻繁に現れること）",
        q_coda_opts: ["はい（-p/-t/-k類の語尾が一般的）", "やや", "非常に少ない/ほぼない", "不明"],
        instructions_tone_title: "問題1：声調判断",
        instructions_tone_text: `
            <p>音声クリップを聴きます。</p>
            <p>注意深く聴いて、<strong>Low</strong>または<strong>High</strong>の声調かを判断してください。</p>
            <p><strong>緑色のボタンをクリックして音声を再生します。</strong>何度でも再生できます。</p>
            <p>「開始」をクリックして始めてください。</p>
        `,
        instructions_kpth_title: "問題2：韻尾判断",
        instructions_kpth_text: `
            <p>別の音声クリップを聴きます。</p>
            <p>注意深く聴いて、聞こえた韻尾を選んでください：</p>
            <ul>
                <li><strong>ak</strong></li>
                <li><strong>ap</strong></li>
                <li><strong>at</strong></li>
                <li><strong>ah</strong></li>
            </ul>
            <p><strong>緑色のボタンをクリックして音声を再生します。</strong>何度でも再生できます。</p>
            <p>「開始」をクリックして始めてください。</p>
        `,
        debrief_title: "テスト完了！",
        debrief_text: `
            <p>ご参加ありがとうございました！</p>
            <p>「データダウンロード」をクリックしてテスト結果を保存してください。</p>
        `,
        play_audio: "クリックして音声を再生",
        prompt_tone: "聞こえた声調を選択してください：",
        prompt_kpth: "聞こえた韻尾を選択してください：",
        button_next: "次へ",
        button_start: "開始",
        button_download: "データダウンロード",
        button_submit: "送信",
        completion_message: "データが保存されました！このページを閉じてください。"
    },
    
    zh_TW: {
        lang_select_title: "語言選擇",
        welcome_title: "歡迎參加感知測試",
        welcome_text: `
            <p>感謝您參與本實驗！</p>
            <p>本測試約需<strong>5分鐘</strong>完成。</p>
            <p>請確保您在安靜的環境中，並佩戴耳機。</p>
            <p>點擊「下一頁」繼續。</p>
        `,
        demographics_title: "參與者資訊",
        q_age: "年齡",
        q_age_opts: ["18-19", "20-22", "23-25", "26-30", "31-40", "41-49", "50-59", "60-69", "70-79", "80+"],
        q_hearing: "聽力狀況",
        q_hearing_opts: ["無已知聽力問題", "有輕微聽力問題/耳鳴", "有明確聽力診斷", "不確定"],
        q_l1: "第一語言（L1）",
        q_l1_opts: ["日語", "英語", "普通話（Mandarin）", "閩南語/台語", "粵語", "韓語", "泰語", "其他（聲調語言）", "其他（非聲調語言）"],
        q_l2: "第二語言/其他熟練語言（可多選）",
        q_l2_note: "（請只選擇您能在日常生活中理解或使用的語言）",
        q_l2_opts: ["日語", "英語", "普通話（Mandarin）", "閩南語/台語", "粵語", "韓語", "泰語", "法語", "德語", "西班牙語", "義大利語", "俄語", "其他（聲調語言）", "其他（非聲調語言）"],
        q_tonal_exposure: "您是否曾長期接觸聲調語言環境？（可多選）",
        q_tonal_exposure_opts: ["家庭或成長環境中使用", "學校/課程學習過", "在聲調語言地區生活過", "朋友/室友經常使用", "幾乎沒有"],
        q_music_training: "您是否接受過音樂訓練？",
        q_music_training_opts: ["沒有", "有（非系統性/興趣）", "有（系統訓練）"],
        q_music_years: "音樂訓練年數",
        q_music_years_opts: ["0", "1-2年", "3-4年", "5-7年", "8-10年", "10年以上"],
        q_absolute_pitch: "您是否具有絕對音感（Absolute Pitch）？",
        q_absolute_pitch_opts: ["是（已被專業測試確認）", "可能有（自我判斷）", "沒有", "不確定"],
        q_device: "使用的測試設備",
        q_device_opts: ["電腦＋耳機", "電腦＋外放", "手機＋耳機", "手機＋外放"],
        q_environment: "當前環境安靜程度",
        q_environment_opts: ["很安靜", "一般", "比較吵"],
        q_phonetics: "您是否學習過語言學/音聲學/發音訓練？",
        q_phonetics_opts: ["沒有", "上過一門課/短期訓練（< 1學期）", "系統學習過（≥ 1學期）", "不確定"],
        q_romanization: "您會不會讀羅馬字/音標來判斷發音？",
        q_romanization_opts: ["完全不會", "有點會（看得懂大概）", "很熟（經常用）", "不確定"],
        q_coda: "您的母語/主要語言裡，詞尾塞音常見嗎？",
        q_coda_note: "（常見指經常有-p/-t/-k或類似閉塞尾）",
        q_coda_opts: ["常見（詞尾經常有-p/-t/-k或類似閉塞尾）", "偶爾有", "很少/幾乎沒有", "不確定"],
        instructions_tone_title: "第一題：聲調判斷",
        instructions_tone_text: `
            <p>您將聽到一段音訊。</p>
            <p>請仔細聆聽，然後判斷這是<strong>Low</strong>還是<strong>High</strong>聲調。</p>
            <p><strong>點擊綠色按鈕播放音訊。</strong>您可以播放多次。</p>
            <p>點擊「開始」繼續。</p>
        `,
        instructions_kpth_title: "第二題：韻尾判斷",
        instructions_kpth_text: `
            <p>您將聽到另一段音訊。</p>
            <p>請仔細聆聽，然後選擇您聽到的韻尾：</p>
            <ul>
                <li><strong>ak</strong></li>
                <li><strong>ap</strong></li>
                <li><strong>at</strong></li>
                <li><strong>ah</strong></li>
            </ul>
            <p><strong>點擊綠色按鈕播放音訊。</strong>您可以播放多次。</p>
            <p>點擊「開始」繼續。</p>
        `,
        debrief_title: "測試完成！",
        debrief_text: `
            <p>感謝您的參與！</p>
            <p>點擊「下載資料」按鈕儲存您的測試結果。</p>
        `,
        play_audio: "點擊播放音訊",
        prompt_tone: "請選擇您聽到的聲調：",
        prompt_kpth: "請選擇您聽到的韻尾：",
        button_next: "下一頁",
        button_start: "開始",
        button_download: "下載資料",
        button_submit: "提交",
        completion_message: "資料已儲存！您可以關閉此頁面。"
    },
    
    zh_CN: {
        lang_select_title: "语言选择",
        welcome_title: "欢迎参加感知测试",
        welcome_text: `
            <p>感谢您参与本实验！</p>
            <p>本测试约需<strong>5分钟</strong>完成。</p>
            <p>请确保您在安静的环境中，并佩戴耳机。</p>
            <p>点击「下一页」继续。</p>
        `,
        demographics_title: "参与者信息",
        q_age: "年龄",
        q_age_opts: ["18-19", "20-22", "23-25", "26-30", "31-40", "41-49", "50-59", "60-69", "70-79", "80+"],
        q_hearing: "听力状况",
        q_hearing_opts: ["无已知听力问题", "有轻微听力问题/耳鸣", "有明确听力诊断", "不确定"],
        q_l1: "第一语言（L1）",
        q_l1_opts: ["日语", "英语", "普通话（Mandarin）", "闽南语/台语", "粤语", "韩语", "泰语", "其他（声调语言）", "其他（非声调语言）"],
        q_l2: "第二语言/其他熟练语言（可多选）",
        q_l2_note: "（请只选择您能在日常生活中理解或使用的语言）",
        q_l2_opts: ["日语", "英语", "普通话（Mandarin）", "闽南语/台语", "粤语", "韩语", "泰语", "法语", "德语", "西班牙语", "意大利语", "俄语", "其他（声调语言）", "其他（非声调语言）"],
        q_tonal_exposure: "您是否曾长期接触声调语言环境？（可多选）",
        q_tonal_exposure_opts: ["家庭或成长环境中使用", "学校/课程学习过", "在声调语言地区生活过", "朋友/室友经常使用", "几乎没有"],
        q_music_training: "您是否接受过音乐训练？",
        q_music_training_opts: ["没有", "有（非系统性/兴趣）", "有（系统训练）"],
        q_music_years: "音乐训练年数",
        q_music_years_opts: ["0", "1-2年", "3-4年", "5-7年", "8-10年", "10年以上"],
        q_absolute_pitch: "您是否具有绝对音感（Absolute Pitch）？",
        q_absolute_pitch_opts: ["是（已被专业测试确认）", "可能有（自我判断）", "没有", "不确定"],
        q_device: "使用的测试设备",
        q_device_opts: ["电脑＋耳机", "电脑＋外放", "手机＋耳机", "手机＋外放"],
        q_environment: "当前环境安静程度",
        q_environment_opts: ["很安静", "一般", "比较吵"],
        q_phonetics: "您是否学习过语言学/音声学/发音训练？",
        q_phonetics_opts: ["没有", "上过一门课/短期训练（< 1学期）", "系统学习过（≥ 1学期）", "不确定"],
        q_romanization: "您会不会读罗马字/音标来判断发音？",
        q_romanization_opts: ["完全不会", "有点会（看得懂大概）", "很熟（经常用）", "不确定"],
        q_coda: "您的母语/主要语言里，词尾塞音常见吗？",
        q_coda_note: "（常见指经常有-p/-t/-k或类似闭塞尾）",
        q_coda_opts: ["常见（词尾经常有-p/-t/-k或类似闭塞尾）", "偶尔有", "很少/几乎没有", "不确定"],
        instructions_tone_title: "第一题：声调判断",
        instructions_tone_text: `
            <p>您将听到一段音频。</p>
            <p>请仔细聆听，然后判断这是<strong>Low</strong>还是<strong>High</strong>声调。</p>
            <p><strong>点击绿色按钮播放音频。</strong>您可以播放多次。</p>
            <p>点击「开始」继续。</p>
        `,
        instructions_kpth_title: "第二题：韵尾判断",
        instructions_kpth_text: `
            <p>您将听到另一段音频。</p>
            <p>请仔细聆听，然后选择您听到的韵尾：</p>
            <ul>
                <li><strong>ak</strong></li>
                <li><strong>ap</strong></li>
                <li><strong>at</strong></li>
                <li><strong>ah</strong></li>
            </ul>
            <p><strong>点击绿色按钮播放音频。</strong>您可以播放多次。</p>
            <p>点击「开始」继续。</p>
        `,
        debrief_title: "测试完成！",
        debrief_text: `
            <p>感谢您的参与！</p>
            <p>点击「下载数据」按钮保存您的测试结果。</p>
        `,
        play_audio: "点击播放音频",
        prompt_tone: "请选择您听到的声调：",
        prompt_kpth: "请选择您听到的韵尾：",
        button_next: "下一页",
        button_start: "开始",
        button_download: "下载数据",
        button_submit: "提交",
        completion_message: "数据已保存！您可以关闭此页面。"
    },
    
    ko: {
        lang_select_title: "언어 선택",
        welcome_title: "지각 테스트에 오신 것을 환영합니다",
        welcome_text: `
            <p>본 실험에 참여해 주셔서 감사합니다!</p>
            <p>이 테스트는 약 <strong>5분</strong>이 소요됩니다.</p>
            <p>조용한 환경에서 헤드폰을 착용해 주세요.</p>
            <p>"다음"을 클릭하여 계속하세요.</p>
        `,
        demographics_title: "참가자 정보",
        q_age: "나이",
        q_age_opts: ["18-19", "20-22", "23-25", "26-30", "31-40", "41-49", "50-59", "60-69", "70-79", "80+"],
        q_hearing: "청력 상태",
        q_hearing_opts: ["알려진 청력 문제 없음", "경미한 청력 문제/이명", "확인된 청력 진단", "불확실"],
        q_l1: "제1언어 (L1)",
        q_l1_opts: ["일본어", "영어", "표준 중국어 (Mandarin)", "민난어/대만어", "광둥어", "한국어", "태국어", "기타 (성조 언어)", "기타 (비성조 언어)"],
        q_l2: "제2언어/기타 능숙한 언어 (복수 선택 가능)",
        q_l2_note: "(일상생활에서 이해하거나 사용할 수 있는 언어만 선택하세요)",
        q_l2_opts: ["일본어", "영어", "표준 중국어 (Mandarin)", "민난어/대만어", "광둥어", "한국어", "태국어", "프랑스어", "독일어", "스페인어", "이탈리아어", "러시아어", "기타 (성조 언어)", "기타 (비성조 언어)"],
        q_tonal_exposure: "성조 언어 환경에 장기간 노출된 적이 있습니까? (복수 선택 가능)",
        q_tonal_exposure_opts: ["가정 또는 성장 환경에서 사용", "학교/수업에서 학습", "성조 언어 지역에서 거주", "친구/동료와 자주 사용", "거의 없음"],
        q_music_training: "음악 훈련을 받은 적이 있습니까?",
        q_music_training_opts: ["아니오", "예 (비체계적/흥미)", "예 (체계적 훈련)"],
        q_music_years: "음악 훈련 연수",
        q_music_years_opts: ["0", "1-2년", "3-4년", "5-7년", "8-10년", "10년 이상"],
        q_absolute_pitch: "절대음감이 있습니까?",
        q_absolute_pitch_opts: ["예 (전문 테스트 확인)", "아마도 (자가 판단)", "아니오", "불확실"],
        q_device: "테스트 장치",
        q_device_opts: ["컴퓨터 + 헤드폰", "컴퓨터 + 스피커", "휴대폰 + 헤드폰", "휴대폰 + 스피커"],
        q_environment: "현재 환경의 조용함",
        q_environment_opts: ["매우 조용함", "보통", "다소 시끄러움"],
        q_phonetics: "언어학/음성학/발음 훈련을 학습한 적이 있습니까?",
        q_phonetics_opts: ["아니오", "1개 과목/단기 훈련 (< 1학기)", "체계적 학습 (≥ 1학기)", "불확실"],
        q_romanization: "로마자/음성 기호로 발음을 판단할 수 있습니까?",
        q_romanization_opts: ["전혀 할 수 없음", "조금 할 수 있음 (매우 일반적)", "잘 할 수 있음 (자주 사용)", "불확실"],
        q_coda: "모국어/주요 언어에서 어말 폐쇄음이 일반적입니까?",
        q_coda_note: "(일반적이란 -p/-t/-k 또는 유사한 종성이 자주 나타나는 것)",
        q_coda_opts: ["예 (-p/-t/-k 같은 종성이 일반적)", "다소", "매우 적음/거의 없음", "불확실"],
        instructions_tone_title: "문제 1: 성조 판단",
        instructions_tone_text: `
            <p>오디오 클립을 듣게 됩니다.</p>
            <p>주의 깊게 듣고 <strong>Low</strong> 또는 <strong>High</strong> 성조인지 판단하세요.</p>
            <p><strong>녹색 버튼을 클릭하여 오디오를 재생하세요.</strong> 여러 번 재생할 수 있습니다.</p>
            <p>"시작"을 클릭하여 시작하세요.</p>
        `,
        instructions_kpth_title: "문제 2: 종성 판단",
        instructions_kpth_text: `
            <p>다른 오디오 클립을 듣게 됩니다.</p>
            <p>주의 깊게 듣고 들은 종성을 선택하세요:</p>
            <ul>
                <li><strong>ak</strong></li>
                <li><strong>ap</strong></li>
                <li><strong>at</strong></li>
                <li><strong>ah</strong></li>
            </ul>
            <p><strong>녹색 버튼을 클릭하여 오디오를 재생하세요.</strong> 여러 번 재생할 수 있습니다.</p>
            <p>"시작"을 클릭하여 시작하세요.</p>
        `,
        debrief_title: "테스트 완료!",
        debrief_text: `
            <p>참여해 주셔서 감사합니다!</p>
            <p>"데이터 다운로드"를 클릭하여 테스트 결과를 저장하세요.</p>
        `,
        play_audio: "클릭하여 오디오 재생",
        prompt_tone: "들은 성조를 선택하세요:",
        prompt_kpth: "들은 종성을 선택하세요:",
        button_next: "다음",
        button_start: "시작",
        button_download: "데이터 다운로드",
        button_submit: "제출",
        completion_message: "데이터가 저장되었습니다! 이 페이지를 닫을 수 있습니다."
    }
};

// 默认语言
let currentLang = 'en';

// 获取翻译
function t(key) {
    return translations[currentLang][key] || translations['en'][key];
}

/******************************************************************************
 * 工具函数
 ******************************************************************************/

function getTimestamp() {
    const dt = new Date();
    const year = dt.getFullYear();
    const month = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    const hour = String(dt.getHours()).padStart(2, '0');
    const minute = String(dt.getMinutes()).padStart(2, '0');
    const second = String(dt.getSeconds()).padStart(2, '0');
    return `${year}${month}${day}_${hour}${minute}${second}`;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

function createAudioPlayer(audioFile) {
    return `
        <div class="audio-player">
            <button class="play-button" onclick="playAudio('${audioFile}')">
                <span class="play-icon">▶</span>
            </button>
            <p>${t('play_audio')}</p>
            <audio id="audio-${audioFile.replace(/[^a-zA-Z0-9]/g, '')}" preload="auto">
                <source src="${audioFile}" type="audio/wav">
            </audio>
        </div>
    `;
}

function playAudio(audioFile) {
    const audioId = 'audio-' + audioFile.replace(/[^a-zA-Z0-9]/g, '');
    const audio = document.getElementById(audioId);
    if (audio) {
        audio.currentTime = 0;
        audio.play();
    }
}

/******************************************************************************
 * 实验流程
 ******************************************************************************/

var timeline = [];

// 语言选择
var language_selection = {
    type: 'html-button-response',
    stimulus: `
        <h1>Language Selection / 言語選択 / 語言選擇 / 语言选择 / 언어 선택</h1>
        <p>Please select your preferred language / 言語を選択してください / 請選擇您的語言 / 请选择您的语言 / 언어를 선택하세요</p>
    `,
    choices: ['English', '日本語', '繁體中文', '简体中文', '한국어'],
    on_finish: function(data) {
        const langMap = ['en', 'ja', 'zh_TW', 'zh_CN', 'ko'];
        currentLang = langMap[data.button_pressed];
    }
};
timeline.push(language_selection);

// 欢迎页
var welcome = {
    type: 'instructions',
    pages: function() {
        return [`<h1>${t('welcome_title')}</h1>
        <div class="instruction-text">${t('welcome_text')}</div>`];
    },
    show_clickable_nav: true,
    button_label_next: function() { return t('button_next'); }
};
timeline.push(welcome);

// 问卷调查
var demographics = {
    type: 'survey-multi-choice',
    questions: function() {
        return [
            {
                prompt: `<strong>1. ${t('q_age')}</strong>`,
                options: t('q_age_opts'),
                required: true,
                name: 'age'
            },
            {
                prompt: `<strong>2. ${t('q_hearing')}</strong>`,
                options: t('q_hearing_opts'),
                required: true,
                name: 'hearing'
            },
            {
                prompt: `<strong>3. ${t('q_l1')}</strong>`,
                options: t('q_l1_opts'),
                required: true,
                name: 'L1'
            },
            {
                prompt: `<strong>4. ${t('q_l2')}</strong><br><small>${t('q_l2_note')}</small>`,
                options: t('q_l2_opts'),
                required: false,
                name: 'L2'
            },
            {
                prompt: `<strong>5. ${t('q_tonal_exposure')}</strong>`,
                options: t('q_tonal_exposure_opts'),
                required: false,
                name: 'tonal_exposure'
            },
            {
                prompt: `<strong>6. ${t('q_music_training')}</strong>`,
                options: t('q_music_training_opts'),
                required: true,
                name: 'music_training'
            },
            {
                prompt: `<strong>7. ${t('q_music_years')}</strong>`,
                options: t('q_music_years_opts'),
                required: true,
                name: 'music_years'
            },
            {
                prompt: `<strong>8. ${t('q_absolute_pitch')}</strong>`,
                options: t('q_absolute_pitch_opts'),
                required: true,
                name: 'absolute_pitch'
            },
            {
                prompt: `<strong>9. ${t('q_device')}</strong>`,
                options: t('q_device_opts'),
                required: true,
                name: 'device'
            },
            {
                prompt: `<strong>10. ${t('q_environment')}</strong>`,
                options: t('q_environment_opts'),
                required: true,
                name: 'environment'
            },
            {
                prompt: `<strong>11. ${t('q_phonetics')}</strong>`,
                options: t('q_phonetics_opts'),
                required: true,
                name: 'phonetics'
            },
            {
                prompt: `<strong>12. ${t('q_romanization')}</strong>`,
                options: t('q_romanization_opts'),
                required: true,
                name: 'romanization'
            },
            {
                prompt: `<strong>13. ${t('q_coda')}</strong><br><small>${t('q_coda_note')}</small>`,
                options: t('q_coda_opts'),
                required: true,
                name: 'coda'
            }
        ];
    },
    preamble: function() {
        return `<h1>${t('demographics_title')}</h1>`;
    },
    button_label: function() { return t('button_submit'); }
};
timeline.push(demographics);

// 第一题说明
var instructions_tone = {
    type: 'instructions',
    pages: function() {
        return [`<h1>${t('instructions_tone_title')}</h1>
        <div class="instruction-text">${t('instructions_tone_text')}</div>`];
    },
    show_clickable_nav: true,
    button_label_next: function() { return t('button_start'); }
};
timeline.push(instructions_tone);

// 第一题：声调判断
var trial_1 = {
    type: 'html-button-response',
    stimulus: function() {
        return `${createAudioPlayer('sounds/V02-UTC001-P-NAN001.wav')}
            <p><strong>${t('prompt_tone')}</strong></p>`;
    },
    choices: ['Low', 'High'],
    data: {
        trial_number: 1,
        stimulus: 'V02-UTC001-P-NAN001.wav',
        task: 'tone_judgment'
    },
    on_finish: function(data) {
        data.response = data.button_pressed === 0 ? 'Low' : 'High';
        data.response_number = data.button_pressed;
    }
};
timeline.push(trial_1);

// 第二题说明
var instructions_kpth = {
    type: 'instructions',
    pages: function() {
        return [`<h1>${t('instructions_kpth_title')}</h1>
        <div class="instruction-text">${t('instructions_kpth_text')}</div>`];
    },
    show_clickable_nav: true,
    button_label_next: function() { return t('button_start'); }
};
timeline.push(instructions_kpth);

// 第二题：kpth判断
var trial_2 = {
    type: 'html-button-response',
    stimulus: function() {
        return `${createAudioPlayer('sounds/V02-UTC001-P-NAN002.wav')}
            <p><strong>${t('prompt_kpth')}</strong></p>`;
    },
    choices: ['ak', 'ap', 'at', 'ah'],
    data: {
        trial_number: 2,
        stimulus: 'V02-UTC001-P-NAN002.wav',
        task: 'kpth_judgment'
    },
    on_finish: function(data) {
        const options = ['ak', 'ap', 'at', 'ah'];
        data.response = options[data.button_pressed];
        data.response_number = data.button_pressed;
    }
};
timeline.push(trial_2);

// 结束页
var debrief = {
    type: 'instructions',
    pages: function() {
        return [`<h1>${t('debrief_title')}</h1>
        <div class="instruction-text">${t('debrief_text')}</div>`];
    },
    show_clickable_nav: true,
    button_label_next: function() { return t('button_download'); }
};
timeline.push(debrief);

/******************************************************************************
 * 运行实验
 ******************************************************************************/

jsPsych.init({
    timeline: timeline,
    show_progress_bar: true,
    on_finish: function() {
        var allData = jsPsych.data.get();
        
        // 获取问卷数据
        var demographicsData = allData.filter({trial_type: 'survey-multi-choice'});
        var demoResponses = demographicsData.count() > 0 ? demographicsData.values()[0].responses : {};
        
        // 获取测试试次数据
        var trial1Data = allData.filter({trial_number: 1});
        var trial2Data = allData.filter({trial_number: 2});
        
        // 创建简化CSV
        var csvContent = "Trial,Response,Response_Number,RT(ms)\n";
        
        if (trial1Data.count() > 0) {
            var t1 = trial1Data.values()[0];
            csvContent += `1,${t1.response},${t1.response_number},${t1.rt}\n`;
        }
        
        if (trial2Data.count() > 0) {
            var t2 = trial2Data.values()[0];
            csvContent += `2,${t2.response},${t2.response_number},${t2.rt}\n`;
        }
        
        // 添加问卷信息到文件头部
        var headerInfo = "\n\n=== Participant Information ===\n";
        for (var key in demoResponses) {
            headerInfo += `${key}: ${demoResponses[key]}\n`;
        }
        csvContent += headerInfo;
        
        var filename = 'kpth_perception_' + getTimestamp() + '.csv';
        downloadCSV(csvContent, filename);
        
        document.querySelector('#jspsych-content').innerHTML = 
            `<h1>${t('completion_message')}</h1>`;
    }
});

</script>
</html>
